<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººäº¤æ˜“è¿½è¹¤ç³»çµ± - Google é›²ç«¯æ•´åˆç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        :root { font-size: 18px; }
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            line-height: 1.6; 
            background-color: #020617;
            color: #f1f5f9;
        }

        .card-stock { background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%); }
        .card-gold { background: linear-gradient(135deg, #78350f 0%, #b45309 100%); }
        .card-strategy { background: linear-gradient(135deg, #4c1d95 0%, #7c3aed 100%); }
        
        .glass-effect { 
            background: rgba(15, 23, 42, 0.95); 
            backdrop-filter: blur(20px); 
            border-bottom: 2px solid rgba(51, 65, 85, 0.5);
        }

        .page-transition { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        .form-input { 
            @apply w-full px-5 py-3.5 rounded-2xl border-2 border-slate-300 bg-white transition-all text-lg font-medium;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            color: #000000 !important;
        }
        .form-input::placeholder { @apply text-slate-400; }
        .form-input:focus { @apply border-blue-500 ring-4 ring-blue-500/20 outline-none; }
        .form-label { @apply block text-base font-black text-slate-200 mb-2.5; }
        
        .checkbox-card { @apply flex items-center gap-4 p-4 rounded-2xl border-2 border-slate-800 bg-slate-900/60 cursor-pointer hover:bg-slate-800 transition-all; }
        .checkbox-card input { @apply w-6 h-6 text-blue-600 rounded-lg focus:ring-blue-500 bg-slate-950 border-slate-600; }

        .rank-gold { @apply bg-amber-900/50 text-amber-400 border-amber-800; }
        .rank-silver { @apply bg-slate-800 text-slate-300 border-slate-700; }
        .rank-bronze { @apply bg-orange-900/50 text-orange-400 border-orange-800; }

        .score-badge { @apply px-4 py-1.5 rounded-full text-sm font-black bg-blue-600 text-white shadow-lg; }
        
        .input-tab { @apply px-5 py-2 rounded-xl text-sm font-black border-2 transition-all cursor-pointer; }
        .input-tab.active { @apply bg-white border-white text-black shadow-lg; }
        .input-tab.inactive { @apply bg-slate-900 border-slate-800 text-slate-500 hover:bg-slate-800; }

        .grid-compact { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; }

        select.form-input {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23334155'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.2em;
        }

        #login-overlay {
            position: fixed;
            inset: 0;
            z-index: 100;
            background-color: #020617;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
        }

        .permission-notice {
            @apply mt-6 p-4 rounded-xl bg-slate-900 border border-slate-800 text-xs text-slate-500 max-w-sm text-left;
        }

        .setup-guide {
            @apply mt-8 p-6 rounded-2xl bg-slate-900 border border-slate-800 text-xs text-slate-400 max-w-md text-left;
        }

        .setup-guide h4 {
            @apply font-black text-blue-400 mb-3 text-sm;
        }

        .setup-guide ol {
            @apply list-decimal list-inside space-y-2;
        }

        .setup-guide li {
            @apply mb-1;
        }

        .setup-guide code {
            @apply bg-slate-950 px-2 py-1 rounded text-blue-300 font-mono text-xs;
        }
    </style>
</head>
<body class="min-h-screen pb-12">

    <!-- ç™»å…¥ç‰† -->
    <div id="login-overlay">
        <div class="bg-blue-600 p-6 rounded-[2.5rem] text-white shadow-2xl mb-8 animate-pulse">
            <i class="fas fa-chart-line text-6xl"></i>
        </div>
        <h1 class="text-4xl font-black text-white mb-4 tracking-tighter">å€‹äººäº¤æ˜“è¿½è¹¤ç³»çµ±</h1>
        <p class="text-slate-400 mb-10 max-w-sm px-6">å•Ÿç”¨é›²ç«¯åŒæ­¥åŠŸèƒ½ï¼Œæ‚¨çš„äº¤æ˜“è³‡æ–™å°‡å®‰å…¨åœ°å„²å­˜æ–¼å€‹äººçš„ Google Sheet ä¸­ã€‚</p>
        
        <div class="flex flex-col gap-4">
            <button id="google-login-btn" onclick="handleAuthClick()" class="flex items-center gap-4 bg-white text-slate-900 px-8 py-4 rounded-2xl font-black text-xl hover:bg-slate-100 transition-all shadow-xl active:scale-95">
                <img src="https://www.gstatic.com/images/branding/product/1x/gsa_512dp.png" class="w-8 h-8" alt="Google Logo">
                ä½¿ç”¨ Google å¸³è™Ÿç™»å…¥
            </button>
            
            <button onclick="skipLogin()" class="text-sm font-bold text-slate-500 hover:text-blue-400 underline transition-all">
                æš«æ™‚è·³éç™»å…¥ (ä½¿ç”¨æœ¬åœ°å„²å­˜)
            </button>
        </div>

        <div class="permission-notice">
            <p class="font-bold text-slate-400 mb-2 underline"><i class="fas fa-info-circle mr-1"></i> ç€è¦½å™¨è¨­å®šæé†’ï¼š</p>
            <ul class="space-y-1">
                <li>â€¢ è«‹å…è¨±å½ˆå‡ºå¼è¦–çª—ã€‚</li>
                <li>â€¢ è«‹å‹¿é˜»æ“‹ç¬¬ä¸‰æ–¹ Cookieã€‚</li>
                <li>â€¢ è‹¥å‡ºç¾å•é¡Œï¼Œè«‹æª¢æŸ¥å»£å‘Šæ””æˆªå™¨ (AdBlock)ã€‚</li>
            </ul>
        </div>

        <div id="setup-guide-container" class="setup-guide hidden">
            <h4>âš™ï¸ è¨­å®šæé†’</h4>
            <ol>
                <li>é€ è¨ª <code>Google Cloud Console</code></li>
                <li>å»ºç«‹ OAuth 2.0 Client IDï¼ˆWeb æ‡‰ç”¨ï¼‰</li>
                <li>æ–°å¢æˆæ¬Š JavaScript ä¾†æºï¼š<code id="origin-url"></code></li>
                <li>è¤‡è£½ <code>CLIENT_ID</code> èˆ‡ <code>API_KEY</code> åˆ°ç¨‹å¼</li>
                <li>é‡æ–°æ•´ç†é é¢å³å¯ç™»å…¥</li>
            </ol>
        </div>
    </div>

    <!-- å°è¦½åˆ— -->
    <nav id="main-nav" class="glass-effect shadow-2xl sticky top-0 z-50 px-6 py-4 hidden">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer" onclick="navigateTo('home')">
                <div class="bg-blue-600 p-2.5 rounded-2xl text-white shadow-xl">
                    <i class="fas fa-chart-line text-2xl"></i>
                </div>
                <h1 class="text-2xl font-black tracking-tighter text-white">å€‹äººäº¤æ˜“è¿½è¹¤ç³»çµ±</h1>
            </div>
            
            <div class="flex items-center gap-4">
                <div id="user-profile" class="flex items-center gap-3 bg-slate-800 p-1.5 pr-4 rounded-2xl border border-slate-700">
                    <img id="user-avatar" src="https://ui-avatars.com/api/?name=User&background=2563eb&color=fff" class="w-10 h-10 rounded-xl border-2 border-blue-500 shadow-lg" alt="Avatar">
                    <div class="flex flex-col">
                        <span id="user-display-name" class="text-sm font-black text-white leading-tight">æœ¬åœ°ä½¿ç”¨è€…</span>
                        <button onclick="handleSignoutClick()" class="text-[10px] font-bold text-red-400 hover:text-red-300 text-left uppercase tracking-tighter">ç™»å‡ºå¸³è™Ÿ</button>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <main id="app-container" class="max-w-7xl mx-auto p-4 md:p-10">
        <!-- å…§å®¹å€åŸŸ -->
    </main>

    <script>
        /**
         * ğŸ”‘ Google API è¨­å®š - ç›´æ¥å¡«å…¥ä½ çš„å€¼
         * 
         * å¦‚ä½•å–å¾—ï¼š
         * 1. åˆ° https://console.cloud.google.com/
         * 2. å»ºç«‹æ–°å°ˆæ¡ˆ
         * 3. å•Ÿç”¨ Google Drive API å’Œ Google Sheets API
         * 4. å»ºç«‹ OAuth 2.0 Client ID (Web æ‡‰ç”¨)
         * 5. åœ¨ã€Œå·²æˆæ¬Šçš„ JavaScript ä¾†æºã€åŠ å…¥ï¼šhttps://ä½ çš„å¸³è™Ÿ.github.io
         * 6. å»ºç«‹ API Keyï¼Œé™åˆ¶æ–¼ HTTP refererï¼šhttps://ä½ çš„å¸³è™Ÿ.github.io/*
         * 7. è¤‡è£½ Client ID å’Œ API Key åˆ°ä¸‹é¢
         */
        const CLIENT_ID = ''; // TODO: å¡«å…¥ä½ çš„ OAuth 2.0 Client ID
        const API_KEY   = ''; // TODO: å¡«å…¥ä½ çš„ API Key
        
        const DISCOVERY_DOCS = [
            "https://www.googleapis.com/discovery/v1/apis/drive/v3/rest",
            "https://www.googleapis.com/discovery/v1/apis/sheets/v4/rest"
        ];
        const SCOPES = 'https://www.googleapis.com/auth/drive.file https://www.googleapis.com/auth/spreadsheets';

        let tokenClient = null;
        let gapiInited = false;
        let gsisInited = false;

        /**
         * è³‡æ–™ç®¡ç†
         */
        const STORAGE_KEY = 'vp_trading_tracker_v5_final';
        const CLOUD_KEY   = 'vp_trading_tracker_cloud_config';

        let tradingData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || { stock: [], gold: [] };
        let cloudConfig = JSON.parse(localStorage.getItem(CLOUD_KEY)) || null;

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(tradingData));
        }

        function saveCloudConfig() {
            localStorage.setItem(CLOUD_KEY, JSON.stringify(cloudConfig));
        }

        /**
         * åˆå§‹åŒ–æª¢æŸ¥ï¼šå¦‚æœæ²’æœ‰è¨­å®š CLIENT_IDï¼Œé¡¯ç¤ºæé†’
         */
        window.addEventListener('DOMContentLoaded', () => {
            if (!CLIENT_ID || !API_KEY) {
                document.getElementById('setup-guide-container').classList.remove('hidden');
                document.getElementById('origin-url').innerText = window.location.origin;
            }
        });

        /**
         * GAPI / GIS åˆå§‹åŒ–
         */
        window.gapiLoaded = function() {
            if (typeof gapi !== 'undefined') {
                gapi.load('client', async () => {
                    try {
                        if (API_KEY) {
                            await gapi.client.init({ apiKey: API_KEY, discoveryDocs: DISCOVERY_DOCS });
                            gapiInited = true;
                            console.log("âœ… GAPI åˆå§‹åŒ–æˆåŠŸ");
                        } else {
                            console.warn("âš ï¸ æœªè¨­å®š API_KEYï¼ŒGAPI åˆå§‹åŒ–ç•¥é");
                        }
                    } catch (err) {
                        console.warn("âŒ GAPI åˆå§‹åŒ–å¤±æ•—", err);
                    }
                });
            }
        };

        window.gisLoaded = function() {
            if (typeof google !== 'undefined' && google.accounts && google.accounts.oauth2) {
                try {
                    if (CLIENT_ID) {
                        tokenClient = google.accounts.oauth2.initTokenClient({
                            client_id: CLIENT_ID,
                            scope: SCOPES,
                            callback: '', 
                        });
                        gsisInited = true;
                        console.log("âœ… GIS åˆå§‹åŒ–æˆåŠŸ");
                    } else {
                        console.warn("âš ï¸ æœªè¨­å®š CLIENT_IDï¼ŒGIS åˆå§‹åŒ–ç•¥é");
                    }
                } catch (err) {
                    console.warn("âŒ GIS åˆå§‹åŒ–å¤±æ•—", err);
                }
            }
        };

        /**
         * ç™»å…¥é‚è¼¯
         */
        async function handleAuthClick() {
            if (!CLIENT_ID || !API_KEY) {
                alert("âŒ CLIENT_ID æˆ– API_KEY æœªè¨­å®šã€‚\n\nè«‹åˆ°ç¨‹å¼ç¢¼é ‚éƒ¨å¡«å…¥ä½ çš„ Google Cloud èªè­‰è³‡è¨Šã€‚");
                return;
            }

            if (!gsisInited || !tokenClient) {
                alert("âŒ Google ç™»å…¥å¥—ä»¶åˆå§‹åŒ–å¤±æ•—ã€‚\n\nè«‹æª¢æŸ¥ï¼š\nâ€¢ æ˜¯å¦æ­£ç¢ºå¡«å…¥ CLIENT_ID\nâ€¢ æ˜¯å¦å…è¨±å½ˆå‡ºå¼è¦–çª—\nâ€¢ å»£å‘Šæ””æˆªå™¨æ˜¯å¦é˜»æ“‹\n\né‡æ–°æ•´ç†é é¢å¾Œå†è©¦ã€‚");
                return;
            }
            
            tokenClient.callback = async (resp) => {
                if (resp.error !== undefined) {
                    console.error("âŒ Auth Error:", resp);
                    alert("ç™»å…¥å¤±æ•—ï¼š" + resp.error);
                    return;
                }

                if (!gapiInited) {
                    alert("âŒ GAPI å°šæœªåˆå§‹åŒ–å®Œæˆï¼Œè«‹ç¨å¾Œå†è©¦ã€‚");
                    return;
                }

                // â˜… ç¬¬ä¸€æ¬¡ç™»å…¥æ™‚åšé›²ç«¯åˆå§‹åŒ–
                await initCloudIfNeeded();
                showAppUI("é›²ç«¯äº¤æ˜“å“¡");
            };

            if (gapi.client.getToken() === null) {
                tokenClient.requestAccessToken({prompt: 'consent'});
            } else {
                tokenClient.requestAccessToken({prompt: ''});
            }
        }

        function skipLogin() {
            showAppUI("æœ¬åœ°ä½¿ç”¨è€…");
        }

        function showAppUI(userName) {
            document.getElementById('login-overlay').classList.add('hidden');
            document.getElementById('main-nav').classList.remove('hidden');
            document.getElementById('user-display-name').innerText = userName;
            navigateTo('home');
        }

        function handleSignoutClick() {
            if (typeof gapi !== 'undefined' && gapi.client && gapi.client.getToken()) {
                const token = gapi.client.getToken();
                google.accounts.oauth2.revoke(token.access_token);
                gapi.client.setToken('');
            }
            location.reload();
        }

        /**
         * é›²ç«¯åˆå§‹åŒ–ï¼šå»ºè³‡æ–™å¤¾ + å»º Sheet + æŠŠç¾æœ‰è³‡æ–™ä¸Ÿä¸Šå»
         */
        async function initCloudIfNeeded() {
            if (cloudConfig && cloudConfig.spreadsheetId) {
                console.log("âœ… å·²æœ‰æ—¢å­˜é›²ç«¯è¨­å®šï¼Œç•¥éåˆå§‹åŒ–");
                return;
            }

            try {
                console.log("ğŸš€ é–‹å§‹åˆå§‹åŒ–é›²ç«¯...");

                // 1. å»º Google Drive è³‡æ–™å¤¾
                const folderRes = await gapi.client.drive.files.create({
                    resource: {
                        name: 'VP Trading Tracker',
                        mimeType: 'application/vnd.google-apps.folder'
                    },
                    fields: 'id'
                });
                const folderId = folderRes.result.id;
                console.log("âœ… è³‡æ–™å¤¾å·²å»ºç«‹:", folderId);

                // 2. å»º Google Sheet (å…©å€‹å·¥ä½œè¡¨ Stock / Gold)
                const sheetRes = await gapi.client.sheets.spreadsheets.create({
                    resource: {
                        properties: { title: 'VP Trading Tracker - Records' },
                        sheets: [
                            { properties: { title: 'Stock' } },
                            { properties: { title: 'Gold' } }
                        ]
                    },
                    fields: 'spreadsheetId'
                });
                const spreadsheetId = sheetRes.result.spreadsheetId;
                console.log("âœ… Google Sheet å·²å»ºç«‹:", spreadsheetId);

                // 3. æŠŠ Sheet ç§»å‹•åˆ°è³‡æ–™å¤¾åº•ä¸‹
                await gapi.client.drive.files.update({
                    fileId: spreadsheetId,
                    addParents: folderId,
                    fields: 'id, parents'
                });
                console.log("âœ… Sheet å·²ç§»åˆ°è³‡æ–™å¤¾");

                cloudConfig = { folderId, spreadsheetId };
                saveCloudConfig();

                // 4. åˆå§‹åŒ–ï¼šæŠŠç¾æœ‰ localStorage çš„è³‡æ–™å¯«é€² Sheet
                await syncAllToSheet(spreadsheetId);
                console.log("âœ… åˆå§‹è³‡æ–™å·²åŒæ­¥åˆ° Sheet");

            } catch (err) {
                console.error("âŒ é›²ç«¯åˆå§‹åŒ–å¤±æ•—", err);
                alert("é›²ç«¯åˆå§‹åŒ–å¤±æ•—ï¼Œæš«æ™‚ä»¥æœ¬åœ°æ¨¡å¼é‹ä½œã€‚\n\néŒ¯èª¤ä¿¡æ¯ï¼š" + (err.message || JSON.stringify(err)));
            }
        }

        async function syncAllToSheet(spreadsheetId) {
            const header = [
                'id', 'date', 'item', 'type', 'rank',
                'entryPrice', 'units', 'tp', 'sl',
                'exitPrice', 'conditions', 'reflection', 'timestamp'
            ];

            const stockValues = [
                header,
                ...tradingData.stock.map(r => [
                    r.id, r.date, r.item, r.type, r.rank,
                    r.entryPrice, r.units, r.tp, r.sl,
                    r.exitPrice, (r.conditions || []).join('|'),
                    r.reflection, r.timestamp
                ])
            ];

            const goldValues = [
                header,
                ...tradingData.gold.map(r => [
                    r.id, r.date, r.item, r.type, r.rank,
                    r.entryPrice, r.units, r.tp, r.sl,
                    r.exitPrice, (r.conditions || []).join('|'),
                    r.reflection, r.timestamp
                ])
            ];

            // è¦†è“‹æ•´å¼µ Stock å·¥ä½œè¡¨
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId,
                range: 'Stock!A1',
                valueInputOption: 'USER_ENTERED',
                resource: { values: stockValues }
            });

            // è¦†è“‹æ•´å¼µ Gold å·¥ä½œè¡¨
            await gapi.client.sheets.spreadsheets.values.update({
                spreadsheetId,
                range: 'Gold!A1',
                valueInputOption: 'USER_ENTERED',
                resource: { values: goldValues }
            });
        }

        async function syncOneRecordToSheet(spreadsheetId, market, record) {
            const sheetName = (market === 'stock') ? 'Stock' : 'Gold';
            const values = [[
                record.id,
                record.date,
                record.item,
                record.type,
                record.rank,
                record.entryPrice,
                record.units,
                record.tp,
                record.sl,
                record.exitPrice,
                (record.conditions || []).join('|'),
                record.reflection,
                record.timestamp
            ]];

            await gapi.client.sheets.spreadsheets.values.append({
                spreadsheetId,
                range: `${sheetName}!A1`,
                valueInputOption: 'USER_ENTERED',
                insertDataOption: 'INSERT_ROWS',
                resource: { values }
            });
        }

        /**
         * äº¤æ˜“åˆ¤å®šé‚è¼¯
         */
        function determineResult(type, entry, exit) {
            const e = parseFloat(entry);
            const x = parseFloat(exit);
            if (isNaN(e) || isNaN(x)) return "å¾…å®š";
            if (type === 'å¤š') {
                return x > e ? "ç²åˆ©" : (x < e ? "è™§æ" : "å¹³æ‰‹");
            } else {
                return x < e ? "ç²åˆ©" : (x > e ? "è™§æ" : "å¹³æ‰‹");
            }
        }

        function calculateTradeScore(record) {
            let score = 0;
            if (record.rank === 'é‡‘å–®') score += 40;
            else if (record.rank === 'éŠ€å–®') score += 25;
            else if (record.rank === 'éŠ…å–®') score += 10;
            (record.conditions || []).forEach(() => score += 10);
            return Math.min(score, 100);
        }

        function calculateRR(entry, tp, sl) {
            const e = parseFloat(entry);
            const t = parseFloat(tp);
            const s = parseFloat(sl);
            if (isNaN(e) || isNaN(t) || isNaN(s) || e === s) return "0.0";
            return (Math.abs(t - e) / Math.abs(e - s)).toFixed(1);
        }

        const stockMap = { "2330": "å°ç©é›»", "2317": "é´»æµ·", "2454": "è¯ç™¼ç§‘", "2303": "è¯é›»", "2603": "é•·æ¦®", "2881": "å¯Œé‚¦é‡‘" };

        /**
         * é é¢æ¸²æŸ“
         */
        window.navigateTo = (page, params = null) => {
            const container = document.getElementById('app-container');
            container.innerHTML = '';
            window.scrollTo(0, 0);

            switch(page) {
                case 'home': renderHome(container); break;
                case 'details': renderDetails(container, params); break;
                case 'strategy': renderStrategy(container); break;
                case 'form': renderForm(container, params.type, params.id); break;
            }
        };

        function renderHome(container) {
            container.innerHTML = `
                <div class="page-transition">
                    <div class="mb-14 mt-4 text-center md:text-left">
                        <h2 class="text-5xl font-black text-white tracking-tighter">æ•¸æ“šå„€è¡¨æ¿</h2>
                        <p class="text-xl text-slate-400 mt-4 font-medium italic">Vegas + VP äº¤æ˜“ç´€å¾‹çš„æ ¸å¿ƒçµ±è¨ˆ</p>
                    </div>

                    <div class="grid md:grid-cols-3 gap-8">
                        <div onclick="navigateTo('details', 'stock')" class="card-stock group p-12 rounded-[3rem] shadow-2xl cursor-pointer transform hover:-translate-y-3 transition-all duration-300 text-white relative overflow-hidden border border-white/10">
                            <i class="fas fa-chart-line text-6xl mb-8 block"></i>
                            <h3 class="text-3xl font-black">å°è‚¡å¸‚å ´ç´€éŒ„</h3>
                            <p class="text-blue-100 opacity-80 mt-2 font-bold text-lg">Stock Trading</p>
                        </div>
                        <div onclick="navigateTo('details', 'gold')" class="card-gold group p-12 rounded-[3rem] shadow-2xl cursor-pointer transform hover:-translate-y-3 transition-all duration-300 text-white relative overflow-hidden border border-white/10">
                            <i class="fas fa-coins text-6xl mb-8 block"></i>
                            <h3 class="text-3xl font-black">é»ƒé‡‘å¸‚å ´ç´€éŒ„</h3>
                            <p class="text-amber-100 opacity-80 mt-2 font-bold text-lg">XAUUSD Trading</p>
                        </div>
                        <div onclick="navigateTo('strategy')" class="card-strategy group p-12 rounded-[3rem] shadow-2xl cursor-pointer transform hover:-translate-y-3 transition-all duration-300 text-white relative overflow-hidden border border-white/10">
                            <i class="fas fa-shield-halved text-6xl mb-8 block text-purple-200"></i>
                            <h3 class="text-3xl font-black">äº¤æ˜“ç­–ç•¥æ¡†æ¶</h3>
                            <p class="text-purple-100 opacity-80 mt-2 font-bold text-lg">Core Strategy</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDetails(container, marketType) {
            const data = tradingData[marketType] || [];
            const settled = data.filter(d => d.exitPrice && d.exitPrice.trim() !== "");
            const wins = settled.filter(d => determineResult(d.type, d.entryPrice, d.exitPrice) === 'ç²åˆ©').length;
            const winRate = settled.length > 0 ? ((wins / settled.length) * 100).toFixed(1) : '0.0';

            container.innerHTML = `
                <div class="page-transition">
                    <div class="flex flex-col md:flex-row justify-between items-end mb-12 gap-6">
                        <div>
                            <button onclick="navigateTo('home')" class="text-slate-500 hover:text-blue-400 mb-4 flex items-center gap-3 text-lg font-black transition-all">
                                <i class="fas fa-chevron-left"></i> è¿”å›é¦–é 
                            </button>
                            <h2 class="text-4xl font-black text-white tracking-tight">${marketType === 'gold' ? 'é»ƒé‡‘ XAUUSD' : 'å°è‚¡å¸‚å ´'}</h2>
                        </div>
                        <button onclick="navigateTo('form', {type: '${marketType}'})" class="bg-blue-600 hover:bg-blue-500 text-white px-10 py-5 rounded-[2rem] flex items-center gap-3 shadow-2xl transition-all active:scale-95 font-black text-xl border border-blue-400/30">
                            <i class="fas fa-plus"></i> æ–°å¢ç´€éŒ„
                        </button>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-8 mb-12">
                        <div class="bg-slate-900 p-10 md:p-14 rounded-[2.5rem] border-2 border-slate-800 shadow-sm text-center">
                            <p class="text-sm font-black text-slate-500 mb-2 uppercase tracking-widest">ç›®å‰å‹ç‡</p>
                            <span class="text-5xl md:text-6xl font-black text-blue-500">${winRate}%</span>
                        </div>
                        <div class="bg-slate-900 p-10 md:p-14 rounded-[2.5rem] border-2 border-slate-800 shadow-sm text-center">
                            <p class="text-sm font-black text-slate-500 mb-2 uppercase tracking-widest">çµ±è¨ˆå–®æ•¸</p>
                            <span class="text-5xl md:text-6xl font-black text-slate-200">${data.length}</span>
                        </div>
                    </div>

                    <div class="space-y-8">
                        ${data.length === 0 ? `<div class="p-32 text-center text-slate-600 text-2xl italic bg-slate-900 rounded-[4rem] border border-dashed border-slate-800">ç„¡ä»»ä½•æœ¬åœ°ç´€éŒ„</div>` : ''}
                        ${data.map(item => {
                            const result = determineResult(item.type, item.entryPrice, item.exitPrice);
                            const isSettled = item.exitPrice && item.exitPrice.trim() !== "";
                            return `
                            <div class="bg-slate-900 rounded-[3.5rem] border border-slate-800 shadow-sm overflow-hidden hover:border-slate-600 transition-all">
                                <div class="p-10 flex-1">
                                    <div class="flex justify-between items-start mb-8">
                                        <div>
                                            <div class="flex items-center gap-4 mb-3">
                                                <span class="text-sm font-bold text-slate-500">${item.date}</span>
                                                <span class="px-4 py-1.5 rounded-xl text-xs font-black border ${getRankClass(item.rank)}">${item.rank || 'æœªåˆ†ç´š'}</span>
                                                <span class="score-badge">Score: ${calculateTradeScore(item)}</span>
                                                <span class="text-xs font-black ${isSettled ? 'text-blue-400' : 'text-amber-500'}">
                                                    ${isSettled ? 'å·²çµå–®' : 'æŒå€‰ä¸­'}
                                                </span>
                                            </div>
                                            <h3 class="text-3xl font-black text-white">
                                                ${item.item} 
                                                <span class="${item.type === 'å¤š' ? 'text-red-400' : 'text-green-400'}">[${item.type}]</span>
                                            </h3>
                                        </div>
                                        <div class="flex gap-4">
                                            <button onclick="navigateTo('form', {type: '${marketType}', id: '${item.id}'})" class="text-slate-600 hover:text-blue-400 transition-all p-4 text-2xl"><i class="fas fa-edit"></i></button>
                                            <button onclick="deleteTrade('${marketType}', '${item.id}')" class="text-slate-600 hover:text-red-500 transition-all p-4 text-2xl"><i class="fas fa-trash-can"></i></button>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 md:grid-cols-4 gap-10 mb-10">
                                        <div><p class="text-slate-500 text-xs font-bold mb-1 uppercase tracking-widest">é€²å ´åƒ¹ / å–®ä½</p><p class="font-mono font-black text-slate-200 text-2xl">${item.entryPrice} / ${item.units}</p></div>
                                        <div><p class="text-slate-500 text-xs font-bold mb-1 uppercase tracking-widest">å‡ºå ´åƒ¹æ ¼</p><p class="font-mono font-black text-blue-400 text-2xl">${item.exitPrice || '-'}</p></div>
                                        <div><p class="text-slate-500 text-xs font-bold mb-1 uppercase tracking-widest">ç›ˆè™§æ¯” (R)</p><p class="font-mono font-black text-purple-400 text-2xl">${calculateRR(item.entryPrice, item.tp, item.sl)} R</p></div>
                                        <div><p class="text-slate-500 text-xs font-bold mb-1 uppercase tracking-widest">åˆ¤å®šçµæœ</p><p class="font-black text-2xl ${result === 'ç²åˆ©' ? 'text-red-400' : (result === 'è™§æ' ? 'text-green-400' : 'text-slate-300')}">${result}</p></div>
                                    </div>

                                    <div class="bg-slate-800/50 p-8 rounded-[2rem] text-lg text-slate-400 leading-relaxed border border-slate-700/50">
                                        <strong class="text-slate-200 font-black">å›æ¸¬åæ€ï¼š</strong> ${item.reflection || 'ç„¡å‚™è¨»'}
                                    </div>
                                </div>
                            </div>
                        `;}).join('')}
                    </div>
                </div>
            `;
        }

        function getRankClass(rank) {
            if (rank === 'é‡‘å–®') return 'rank-gold';
            if (rank === 'éŠ€å–®') return 'rank-silver';
            if (rank === 'éŠ…å–®') return 'rank-bronze';
            return 'bg-slate-800 text-slate-500 border-slate-700';
        }

        window.switchInputMethod = (method) => {
            const autoBox = document.getElementById('auto-lookup-box');
            const manualBox = document.getElementById('manual-input-box');
            const autoTab = document.getElementById('tab-auto');
            const manualTab = document.getElementById('tab-manual');

            if (method === 'auto') {
                autoBox.classList.remove('hidden'); manualBox.classList.add('hidden');
                autoTab.classList.add('active'); autoTab.classList.remove('inactive');
                manualTab.classList.remove('active'); manualTab.classList.add('inactive');
            } else {
                autoBox.classList.add('hidden'); manualBox.classList.remove('hidden');
                autoTab.classList.remove('active'); autoTab.classList.add('inactive');
                manualTab.classList.add('active'); manualTab.classList.remove('inactive');
            }
        };

        window.lookupStockId = (id) => {
            const display = document.getElementById('auto-lookup-result');
            const hiddenInput = document.getElementById('item-hidden-input');
            if (stockMap[id]) {
                display.innerText = `æ‰¾åˆ°æ¨™çš„ï¼š${stockMap[id]}`;
                display.className = "mt-2 text-sm text-blue-400 font-black";
                hiddenInput.value = `${id} ${stockMap[id]}`;
            } else {
                display.innerText = id.length >= 4 ? "æŸ¥ç„¡æ­¤ä»£è™Ÿï¼Œè«‹ä½¿ç”¨æ‰‹å‹•è¼¸å…¥" : "è«‹è¼¸å…¥ 4 ç¢¼ä»£è™Ÿ";
                display.className = "mt-2 text-sm text-slate-500 font-bold";
                hiddenInput.value = "";
            }
        };

        function renderForm(container, marketType, id = null) {
            const isEdit = id !== null;
            const isGold = marketType === 'gold';
            let record = isEdit ? tradingData[marketType].find(r => r.id === id) : {
                id: Date.now().toString(), date: new Date().toISOString().split('T')[0], 
                item: isGold ? 'é»ƒé‡‘ XAUUSD' : '', 
                type: 'å¤š', rank: '', entryPrice: '', 
                units: isGold ? '0.01' : '1',
                tp: '', sl: '', exitPrice: '',
                conditions: [], reflection: ''
            };

            container.innerHTML = `
                <div class="page-transition max-w-7xl mx-auto mb-32">
                    <button onclick="navigateTo('details', '${marketType}')" class="text-slate-500 hover:text-blue-400 mb-10 flex items-center gap-3 font-black text-xl transition-all">
                        <i class="fas fa-chevron-left"></i> å–æ¶ˆä¸¦è¿”å›
                    </button>

                    <div class="bg-slate-900 rounded-[4rem] shadow-2xl border border-slate-800 overflow-hidden">
                        <div class="bg-slate-800/50 px-14 py-12 border-b border-slate-800">
                            <h2 class="text-4xl font-black text-white">${isEdit ? 'ç·¨è¼¯' : 'æ–°å¢'} ${isGold ? 'é»ƒé‡‘' : 'å°è‚¡'} äº¤æ˜“ç´€éŒ„</h2>
                        </div>
                        
                        <form id="trading-form" class="p-14 space-y-14">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
                                <div><label class="form-label">é€²å ´æ—¥æœŸ</label><input type="date" name="date" value="${record.date}" class="form-input" required></div>
                                <div class="md:col-span-1">
                                    <label class="form-label">äº¤æ˜“æ¨™å®š</label>
                                    ${!isGold ? `
                                    <div class="flex gap-2 mb-4">
                                        <div id="tab-auto" class="input-tab active" onclick="switchInputMethod('auto')">ä»£è™ŸæŸ¥æ‰¾</div>
                                        <div id="tab-manual" class="input-tab inactive" onclick="switchInputMethod('manual')">æ‰‹å‹•è¼¸å…¥</div>
                                    </div>
                                    <div id="auto-lookup-box">
                                        <input type="text" placeholder="ä¾‹å¦‚ï¼š2330" class="form-input" oninput="lookupStockId(this.value)">
                                        <p id="auto-lookup-result" class="mt-2 text-sm text-slate-500 font-bold">è‡ªå‹•åŒ¹é…åç¨±</p>
                                        <input type="hidden" id="item-hidden-input" name="item" value="${record.item}">
                                    </div>
                                    <div id="manual-input-box" class="hidden">
                                        <input type="text" class="form-input" placeholder="æ‰‹å‹•æ¨™çš„åç¨±" oninput="document.getElementById('item-hidden-input').value = this.value">
                                    </div>
                                    ` : `
                                    <input type="text" value="é»ƒé‡‘ XAUUSD" class="form-input bg-slate-100" readonly>
                                    <input type="hidden" name="item" value="é»ƒé‡‘ XAUUSD">
                                    `}
                                </div>
                                <div>
                                    <label class="form-label">äº¤æ˜“æ–¹å‘</label>
                                    <select name="type" id="type-select" class="form-input font-black" onchange="updateFormUI(this.value, '${marketType}')">
                                        <option value="å¤š" ${record.type === 'å¤š' ? 'selected' : ''}>å¤šå–® (Long)</option>
                                        <option value="ç©º" ${record.type === 'ç©º' ? 'selected' : ''}>ç©ºå–® (Short)</option>
                                    </select>
                                </div>
                            </div>

                            <section>
                                <h3 class="text-xl font-black text-blue-500 mb-8 border-b border-slate-800 pb-3">æ ¸å¿ƒè©•åˆ†èˆ‡ç­‰ç´šæ¬Šé‡</h3>
                                <div class="grid md:grid-cols-2 gap-12">
                                    <div class="space-y-4" id="condition-section"></div>
                                    <div class="space-y-4" id="rank-section"></div>
                                </div>
                            </section>

                            <section>
                                <h3 class="text-xl font-black text-blue-500 mb-8 border-b border-slate-800 pb-3">äº¤æ˜“æ•¸æ“šåˆ†æ</h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-8">
                                    <div><label class="form-label">å–®ä½ ${!isGold ? '(å¼µ)' : ''}</label><input type="text" name="units" value="${record.units}" class="form-input"></div>
                                    <div><label class="form-label">é€²å ´åƒ¹æ ¼</label><input type="text" id="entry-price" name="entryPrice" value="${record.entryPrice}" class="form-input" placeholder="è«‹è¼¸å…¥é€²å ´é»ä½" oninput="refreshCalculations()" required></div>
                                    <div><label class="form-label">åœåˆ© TP</label><input type="text" id="tp-price" name="tp" value="${record.tp}" class="form-input" placeholder="ç²åˆ©ç›®æ¨™" oninput="refreshCalculations()"></div>
                                    <div><label class="form-label">åœæ SL</label><input type="text" id="sl-price" name="sl" value="${record.sl}" class="form-input" placeholder="é˜²å®ˆä½" oninput="refreshCalculations()"></div>
                                </div>
                                <div class="mt-10">
                                    <label class="form-label text-blue-400 text-xs uppercase tracking-widest">å‡ºå ´åƒ¹æ ¼ (å¡«å¯«å¾Œè‡ªå‹•åˆ¤å®šçµå–®èˆ‡å‹è² )</label>
                                    <input type="text" id="exit-price" name="exitPrice" value="${record.exitPrice}" class="form-input border-blue-500/50" oninput="refreshCalculations()">
                                </div>
                                
                                <div class="mt-10 bg-slate-800 text-white p-10 rounded-[2.5rem] flex flex-col md:flex-row justify-between items-center shadow-inner border border-slate-700">
                                    <div class="flex gap-10">
                                        <div><span class="text-slate-500 font-bold block mb-1 uppercase text-xs">ç›ˆè™§æ¯”</span><span id="rr-preview" class="text-3xl font-black text-purple-400">0.0 R</span></div>
                                        <div><span class="text-slate-500 font-bold block mb-1 uppercase text-xs">åˆ¤å®š</span><span id="result-preview" class="text-3xl font-black text-white">-</span></div>
                                    </div>
                                    <div class="text-center md:text-right">
                                        <span class="text-slate-500 font-bold block mb-1 uppercase text-xs">ç¶œåˆå¾—åˆ†</span>
                                        <span id="score-preview" class="text-5xl font-black text-green-400">0 Pts</span>
                                    </div>
                                </div>
                            </section>

                            <section class="w-full">
                                <label class="form-label">è¤‡ç›¤èˆ‡æª¢è¨ç´€éŒ„</label>
                                <textarea name="reflection" rows="14" class="form-input block w-full" style="width: 100% !important; min-width: 100% !important;" placeholder="è¨˜éŒ„æ‚¨çš„å¿ƒç†ç‹€æ…‹ã€ç´€å¾‹åŸ·è¡Œæˆ–æŠ€è¡“ç´°ç¯€...">${record.reflection}</textarea>
                            </section>

                            <div class="pt-10">
                                <button type="button" onclick="handleSave('${marketType}', '${record.id}')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-8 rounded-[2rem] shadow-2xl transition-all active:scale-[0.98] text-2xl uppercase border border-blue-400/30 tracking-widest">
                                    å„²å­˜ä¸¦åŒæ­¥äº¤æ˜“ç´€éŒ„
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            updateFormUI(record.type, marketType, record.conditions, record.rank);
            refreshCalculations();
        }

        window.updateFormUI = (tradeType, marketType, savedConds = [], savedRank = '') => {
            const condEl = document.getElementById('condition-section');
            const rankEl = document.getElementById('rank-section');
            let conds = (tradeType === 'å¤š') ? ['Vegasé€šé“å¾€ä¸Š', 'RSIé»ƒé‡‘äº¤å‰'] : ['Vegasé€šé“å¾€ä¸‹', 'RSIæ­»äº¡äº¤å‰'];
            let ranks = (tradeType === 'å¤š') 
                ? [{n:'é‡‘å–®',d:'VALæ’é‡'}, {n:'éŠ€å–®',d:'VAL/POCå€é–“'}, {n:'éŠ…å–®',d:'POCè™•'}] 
                : [{n:'é‡‘å–®',d:'VAHæ’é‡'}, {n:'éŠ€å–®',d:'VAL/POCå€é–“'}, {n:'éŠ…å–®',d:'POCè™•'}];
            condEl.innerHTML = conds.map(c => 
                `<label class="checkbox-card"><input type="checkbox" name="conditions" value="${c}" ${savedConds.includes(c)?'checked':''} onchange="refreshCalculations()"> <span class="text-base font-black text-slate-200">${c}</span></label>`
            ).join('');
            rankEl.innerHTML = ranks.map(r => 
                `<label class="checkbox-card ${savedRank === r.n ? 'ring-4 ring-blue-500 bg-slate-800' : ''}">
                    <input type="radio" name="rank" value="${r.n}" ${savedRank === r.n ? 'checked' : ''} onchange="refreshCalculations()"> 
                    <div class="flex-1 flex justify-between items-center">
                        <div class="flex flex-col">
                            <span class="font-black text-slate-200 text-lg">${r.n}</span>
                            <span class="text-xs text-slate-500 font-bold">${r.d}</span>
                        </div>
                    </div>
                </label>`
            ).join('');
        };

        window.refreshCalculations = () => {
            const entry = document.getElementById('entry-price').value;
            const exit = document.getElementById('exit-price').value;
            const type = document.getElementById('type-select').value;
            const tp = document.getElementById('tp-price').value;
            const sl = document.getElementById('sl-price').value;

            const res = determineResult(type, entry, exit);
            const resEl = document.getElementById('result-preview');
            resEl.innerText = res;
            resEl.className = `text-3xl font-black ${res === 'ç²åˆ©' ? 'text-red-400' : (res === 'è™§æ' ? 'text-green-400' : 'text-slate-300')}`;

            document.getElementById('rr-preview').innerText = calculateRR(entry, tp, sl) + " R";

            const rank = document.querySelector('input[name="rank"]:checked')?.value;
            const conditions = Array.from(document.querySelectorAll('input[name="conditions"]:checked')).map(e => e.value);
            const score = calculateTradeScore({ rank, conditions });
            document.getElementById('score-preview').innerText = score + " Pts";
        };

        window.handleSave = (market, id) => {
            const form = document.getElementById('trading-form');
            const formData = new FormData(form);
            const record = {
                id: id,
                date: formData.get('date'),
                item: formData.get('item'),
                type: formData.get('type'),
                rank: formData.get('rank'),
                entryPrice: formData.get('entryPrice'),
                units: formData.get('units'),
                tp: formData.get('tp'),
                sl: formData.get('sl'),
                exitPrice: formData.get('exitPrice'),
                conditions: Array.from(document.querySelectorAll('input[name="conditions"]:checked')).map(e => e.value),
                reflection: formData.get('reflection'),
                timestamp: Date.now()
            };
            const index = tradingData[market].findIndex(r => r.id === id);
            if (index > -1) tradingData[market][index] = record;
            else tradingData[market].unshift(record);

            saveData();

            if (cloudConfig && cloudConfig.spreadsheetId && gapiInited) {
                syncOneRecordToSheet(cloudConfig.spreadsheetId, market, record)
                    .catch(err => console.error("âŒ é›²ç«¯åŒæ­¥å¤±æ•—", err));
            }

            navigateTo('details', market);
        };

        window.deleteTrade = (market, id) => {
            if (confirm('ç¢ºå®šæ°¸ä¹…åˆªé™¤ï¼Ÿ')) {
                tradingData[market] = tradingData[market].filter(r => r.id !== id);
                saveData();
                navigateTo('details', market);
            }
        };

        function renderStrategy(container) {
            container.innerHTML = `
                <div class="page-transition">
                    <button onclick="navigateTo('home')" class="text-slate-500 hover:text-blue-400 mb-10 flex items-center gap-3 font-black text-xl transition-all">
                        <i class="fas fa-chevron-left"></i> è¿”å›ä¸»é 
                    </button>
                    <div class="flex items-center gap-6 mb-16">
                        <div class="bg-blue-600 text-white p-6 rounded-[2.5rem] shadow-2xl"><i class="fas fa-scroll text-4xl"></i></div>
                        <div><h2 class="text-4xl font-black text-white">æ ¸å¿ƒäº¤æ˜“ç­–ç•¥æ¡†æ¶</h2><p class="text-xl text-slate-500 font-bold">å››å¤§æ”¯æŸ±ï¼šå¾è¶¨å‹¢åˆ°æŠ€è¡“åŸ·è¡Œ</p></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-16">
                        <div class="bg-slate-900 p-10 rounded-[3rem] border border-slate-800 shadow-sm"><h3 class="text-2xl font-black text-blue-500 mb-6">1. è¶¨å‹¢ç¢ºèª (Trend)</h3><p class="text-slate-400 text-lg">è§€å¯Ÿå¤§æ™‚å€ Vegas é€šé“ã€‚åƒ¹æ ¼åœ¨é€šé“ä¹‹ä¸Šä¸”é€šé“å‘ä¸Šç‚ºå¤šé ­ï¼›åä¹‹ç‚ºç©ºé ­ã€‚çµ•ä¸é€†å‹¢è€Œç‚ºã€‚</p></div>
                        <div class="bg-slate-900 p-10 rounded-[3rem] border border-slate-800 shadow-sm"><h3 class="text-2xl font-black text-blue-500 mb-6">2. åŸºæœ¬é¢åŠ åˆ† (Fundamental)</h3><p class="text-slate-400 text-lg">è§€å¯Ÿç‡Ÿæ”¶è¡¨ç¾ã€åˆ©ç‡é æœŸæˆ–å®è§€ç’°å¢ƒã€‚è‰¯å¥½çš„åŸºæœ¬é¢æ±ºå®šäº†æŒå€‰ä¿¡å¿ƒã€‚</p></div>
                        <div class="bg-slate-900 p-10 rounded-[3rem] border border-slate-800 shadow-sm"><h3 class="text-2xl font-black text-blue-500 mb-6">3. æ¶ˆæ¯é¢åŠ åˆ† (News)</h3><p class="text-slate-400 text-lg">é—œæ³¨åœ°ç·£æ”¿æ²»ã€æ³•äººç±Œç¢¼æˆ–çªç™¼æ¶ˆæ¯ã€‚æ¶ˆæ¯é¢æ˜¯åƒ¹æ ¼å¿«é€Ÿè„«é›¢æˆæœ¬å€çš„è§¸åª’ã€‚</p></div>
                        <div class="bg-slate-900 p-10 rounded-[3rem] border border-slate-800 shadow-sm"><h3 class="text-2xl font-black text-blue-500 mb-6">4. æŠ€è¡“åŸ·è¡Œ (Technical)</h3><p class="text-slate-400 text-lg">ä¾æ“š VP ç­‰ç´šåˆ¤æ–·å…¥å ´ï¼Œçµåˆ RSI äº¤å‰æ‰£æ¿æ©Ÿã€‚åš´æ ¼åŸ·è¡Œ TP/SLã€‚</p></div>
                    </div>
                </div>
            `;
        }
    </script>

    <!-- GAPI / GIS è¼‰å…¥ -->
    <script src="https://apis.google.com/js/api.js?onload=gapiLoaded" async defer></script>
    <script src="https://accounts.google.com/gsi/client" async defer onload="gisLoaded()"></script>
</body>
</html>
