<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å€‹äººäº¤æ˜“è¿½è¹¤ç³»çµ±</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        :root {
            font-size: 18px;
            --bs-primary: #2563eb;
            --bs-danger: #dc3545;
            --bs-success: #198754;
            --bs-warning: #ffc107;
            --bs-info: #0dcaf0;
            --bs-dark: #212529;
            --bs-light: #f8f9fa;
            --color-gold: #fbbf24;
            --color-silver: #cbd5e1;
            --color-bronze: #b45309;
        }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            line-height: 1.6;
            background-color: #020617;
            color: #f1f5f9;
            padding-bottom: 3rem;
        }

        .card-stock { 
            background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
            border: 1px solid rgba(255,255,255,0.1) !important;
        }
        .card-gold { 
            background: linear-gradient(135deg, #78350f 0%, #b45309 100%);
            border: 1px solid rgba(255,255,255,0.1) !important;
        }
        .card-euro { 
            background: linear-gradient(135deg, #0f766e 0%, #14b8a6 100%);
            border: 1px solid rgba(255,255,255,0.1) !important;
        }
        .card-strategy { 
            background: linear-gradient(135deg, #4c1d95 0%, #7c3aed 100%);
            border: 1px solid rgba(255,255,255,0.1) !important;
        }
        
        .glass-effect {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 2px solid rgba(51, 65, 85, 0.5);
        }

        .form-control {
            background-color: #ffffff;
            color: #000000;
            border: 2px solid #cbd5e1;
            border-radius: 1.5rem;
            padding: 1.5rem 1.5rem;
            font-size: 1rem;
            min-height: 56px;
            font-weight: 500;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .form-control::placeholder {
            color: #94a3b8;
        }

        .form-control:focus {
            background-color: #ffffff;
            color: #000000;
            border-color: #2563eb;
            box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.25);
            outline: none;
        }

        .form-control.select-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23334155'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.2em;
            padding-right: 3rem;
        }

        .form-label {
            display: block;
            font-size: 1rem;
            font-weight: 900;
            color: #cbd5e1;
            margin-bottom: 0.75rem;
        }

        .rank-gold {
            background: var(--color-gold);
            color: black;
            border: 1px solid #fcd34d;
            box-shadow: 0 0 15px rgba(250, 204, 21, 0.4);
            border-radius: 0.5rem;
            font-weight: 900;
            padding: 0.375rem 1rem;
            display: inline-block;
        }

        .rank-silver {
            background: var(--color-silver);
            color: black;
            border: 1px solid #f1f5f9;
            box-shadow: 0 0 15px rgba(203, 213, 225, 0.3);
            border-radius: 0.5rem;
            font-weight: 900;
            padding: 0.375rem 1rem;
            display: inline-block;
        }

        .rank-bronze {
            background: var(--color-bronze);
            color: white;
            border: 1px solid #f97316;
            box-shadow: 0 0 15px rgba(234, 88, 12, 0.3);
            border-radius: 0.5rem;
            font-weight: 900;
            padding: 0.375rem 1rem;
            display: inline-block;
        }

        .rank-none {
            background: #020617;
            color: #f9fafb;
            border: 1px solid #ffffff;
            box-shadow: 0 0 15px rgba(15, 23, 42, 0.5);
            border-radius: 0.5rem;
            font-weight: 900;
            padding: 0.375rem 1rem;
            display: inline-block;
        }

        .score-badge {
            padding: 0.375rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 900;
            background: #2563eb;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: inline-block;
        }

        .input-tab {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            font-weight: 900;
            border: 2px solid transparent;
            cursor: pointer;
            user-select: none;
        }

        .input-tab.active {
            background: white;
            border: 2px solid white;
            color: black;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .input-tab.inactive {
            background: #1e293b;
            border: 2px solid #1e293b;
            color: #64748b;
        }

        #delete-modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            align-items: center;
            justify-content: center;
        }

        .nav-navbar {
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .checkbox-input {
            width: 1.5rem;
            height: 1.5rem;
            accent-color: #2563eb;
            border: 1px solid #64748b;
            cursor: pointer;
        }

        .card-hover {
            transform: translateY(0);
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .card-hover:hover {
            transform: translateY(-0.75rem);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .page-transition {
            /* ç§»é™¤å‹•ç•« */
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .textarea-large {
            min-height: 420px;
            font-family: 'Noto Sans TC', sans-serif;
        }

        .stat-box {
            background: #1e293b;
            border: 2px solid #334155;
            border-radius: 2.5rem;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-label {
            font-size: 0.75rem;
            font-weight: 900;
            color: #64748b;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 900;
            color: #e2e8f0;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        .rounded-3xl {
            border-radius: 2rem;
        }

        .rounded-4xl {
            border-radius: 3rem;
        }

        .btn-primary-custom {
            background: #2563eb;
            border: none;
            color: white;
            font-weight: 900;
            padding: 1.25rem 2.5rem;
            border-radius: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .btn-primary-custom:hover {
            background: #1d4ed8;
        }

        .btn-primary-custom:active {
            transform: scale(0.98);
        }

        .btn-danger-custom {
            background: #dc2626;
            border: none;
            color: white;
            font-weight: 900;
            padding: 1.25rem 2.5rem;
            border-radius: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.2);
        }

        .btn-danger-custom:hover {
            background: #b91c1c;
        }

        .container-max {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .w-full {
            width: 100%;
        }

        .mb-14 {
            margin-bottom: 3.5rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .flex-center {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gap-4 {
            gap: 1rem;
        }

        .gap-6 {
            gap: 1.5rem;
        }

        .gap-8 {
            gap: 2rem;
        }
    </style>
</head>
<body>

    <!-- åˆªé™¤ç¢ºèªè¦–çª— -->
    <div id="delete-modal">
        <div class="bg-dark border-2 p-5 rounded-4xl" style="max-width: 25rem; width: 100%; margin: 0 1rem;">
            <div class="text-danger mb-5 text-center" style="font-size: 3rem;">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="h4 fw-black text-white text-center mb-3">ç¢ºå®šæ°¸ä¹…åˆªé™¤ï¼Ÿ</h3>
            <p class="text-secondary text-center mb-5">æ­¤æ“ä½œç„¡æ³•å¾©åŸï¼Œè©²ç­†äº¤æ˜“ç´€éŒ„å°‡å¾æœ¬åœ°å„²å­˜ç©ºé–“ç§»é™¤ã€‚</p>
            <div class="d-flex gap-3">
                <button onclick="closeDeleteModal()" class="btn btn-secondary flex-grow-1 fw-bold py-3">å–æ¶ˆ</button>
                <button id="confirm-delete-btn" class="btn btn-danger flex-grow-1 fw-bold py-3">ç¢ºå®šåˆªé™¤</button>
            </div>
        </div>
    </div>

    <!-- å°è¦½åˆ— -->
    <nav class="glass-effect nav-navbar">
        <div class="container-max">
            <div class="d-flex justify-content-between align-items-center py-3">
                <div class="d-flex align-items-center gap-3 cursor-pointer" onclick="navigateTo('home')" style="cursor: pointer;">
                    <div class="bg-primary p-2 rounded-3xl text-white" style="box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
                        <i class="fas fa-chart-line" style="font-size: 1.5rem;"></i>
                    </div>
                    <h1 class="h3 fw-black text-white mb-0">å€‹äººäº¤æ˜“è¿½è¹¤ç³»çµ±</h1>
                </div>
                
                <div class="d-flex align-items-center gap-2 bg-dark px-3 py-2 rounded-3xl border" style="border-color: #475569;">
                    <i class="fas fa-database" style="font-size: 0.875rem; color: #2563eb;"></i>
                    <span class="small fw-bold text-secondary">æœ¬åœ°å„²å­˜æ¨¡å¼</span>
                </div>
            </div>
        </div>
    </nav>

    <main id="app-container" class="container-max">
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        /** 1. è³‡æ–™ç®¡ç† **/
        const STORAGE_KEY = 'vp_trading_tracker_v5_local_final';
        
        const initialData = {
            stock: [],
            gold: [],
            euro: [],
            generalInsights: ''
        };

        let tradingData = JSON.parse(localStorage.getItem(STORAGE_KEY));
        const initMarker = localStorage.getItem(STORAGE_KEY + '_initialized');

        if (!tradingData || !initMarker || (tradingData.stock.length === 0 && tradingData.gold.length === 0 && tradingData.euro.length === 0)) {
            tradingData = initialData;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(tradingData));
            localStorage.setItem(STORAGE_KEY + '_initialized', 'true');
        } else if (!tradingData.euro) {
            tradingData.euro = [];
            localStorage.setItem(STORAGE_KEY, JSON.stringify(tradingData));
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(tradingData));
        }

        window.exportTradingData = () => {
            const dataStr = JSON.stringify(tradingData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const now = new Date();
            const ts = now.toISOString().slice(0,19).replace(/[:T]/g, '-');
            a.href = url;
            a.download = `trading_backup_${ts}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        window.importTradingData = (file) => {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const obj = JSON.parse(e.target.result);
                    if (!obj || !Array.isArray(obj.stock) || !Array.isArray(obj.gold)) {
                        alert('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼ä¸æ­£ç¢ºï¼ˆç¼ºå°‘ stock/gold é™£åˆ—ï¼‰ã€‚');
                        return;
                    }
                    tradingData = {
                        stock: obj.stock,
                        gold: obj.gold,
                        euro: obj.euro || [],
                        generalInsights: obj.generalInsights || ''
                    };
                    saveData();
                    alert('åŒ¯å…¥å®Œæˆï¼Œå·²å¥—ç”¨æ–°çš„äº¤æ˜“ç´€éŒ„ã€‚');
                    navigateTo('home');
                } catch (err) {
                    console.error(err);
                    alert('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆå…§å®¹ä¸æ˜¯åˆæ³•çš„ JSONã€‚');
                }
            };
            reader.readAsText(file, 'utf-8');
        };

        /** 2. æ ¸å¿ƒé‚è¼¯ **/
        function determineResult(type, entry, exit) {
            const e = parseFloat(entry);
            const x = parseFloat(exit);
            if (isNaN(e) || isNaN(x)) return "å¾…å®š";
            if (type === 'å¤š') return x > e ? "ç²åˆ©" : (x < e ? "è™§æ" : "å¹³æ‰‹");
            else return x < e ? "ç²åˆ©" : (x > e ? "è™§æ" : "å¹³æ‰‹");
        }

        function calculateTradeScore(record) {
            let score = 0;
            if (record.rank === 'é‡‘å–®') score += 40;
            else if (record.rank === 'éŠ€å–®') score += 25;
            else if (record.rank === 'éŠ…å–®') score += 10;
            score += (record.conditions || []).length * 10;
            if (record.fundamental) score += 20;
            if (record.news) score += 20;
            return Math.min(score, 100);
        }

        function calculateRR(type, entry, tp, sl) {
            const e = parseFloat(entry);
            const t = parseFloat(tp);
            const s = parseFloat(sl);
            if (isNaN(e) || isNaN(t) || isNaN(s) || e === s) return "0.0";
            let rr = (type === 'å¤š') ? (t - e) / (e - s) : (e - t) / (s - e);
            return rr > 0 ? rr.toFixed(1) : "0.0";
        }

        function calculateFinalRR(type, entry, sl, exit) {
            const e = parseFloat(entry);
            const s = parseFloat(sl);
            const x = parseFloat(exit);
            if (isNaN(e) || isNaN(s) || isNaN(x) || e === s) return 0;
            return (type === 'å¤š') ? (x - e) / (e - s) : (e - x) / (s - e);
        }

        function calculatePnL(record, marketType) {
            const e = parseFloat(record.entryPrice);
            const x = parseFloat(record.exitPrice);
            if (isNaN(e) || isNaN(x)) return 0;
            if (marketType === 'gold') {
                const units = parseFloat(record.units || '0.01');
                const diff = (record.type === 'å¤š') ? (x - e) : (e - x);
                // é»ƒé‡‘ï¼š0.01æ‰‹1é» = 1USDï¼ˆä¿‚æ•¸100ï¼‰
                const grossPnL = diff * 100 * units;
                // æ‰‹çºŒè²»ï¼ˆæŒ‰å–®ä½æ¯”ä¾‹ï¼‰0.03 Ã— (å–®ä½ / 0.01) Ã— 2
                const commissionFee = 0.03 * (units / 0.01) * 2;
                return grossPnL - commissionFee;
            } else if (marketType === 'euro') {
                const units = parseFloat(record.units || '0.01');
                const diff = (record.type === 'å¤š') ? (x - e) : (e - x);
                // æ­å…ƒï¼š0.01æ‰‹1é» = 1USDï¼ˆä¿‚æ•¸10000ï¼‰
                const grossPnL = diff * 10000 * units;
                // æ‰‹çºŒè²»ï¼ˆæŒ‰å–®ä½æ¯”ä¾‹ï¼‰0.03 Ã— (å–®ä½ / 0.01) Ã— 2
                const commissionFee = 0.03 * (units / 0.01) * 2;
                return grossPnL - commissionFee;
            } else {
                const units = parseFloat(record.units || '1');
                const diff = (record.type === 'å¤š') ? (x - e) : (e - x);
                
                // æ‰‹çºŒè²»ï¼ˆè²·é€² + è³£å‡ºï¼‰
                const commissionFee = (e * units * 1000 * 0.001425) + (x * units * 1000 * 0.001425);
                
                // è­‰äº¤ç¨…ï¼ˆåªåœ¨è³£å‡ºæ™‚æ‰£ï¼Œ0.3%ï¼‰
                // å¤šå–®ï¼šè³£å‡ºæ™‚æ‰£ï¼›ç©ºå–®ï¼šè²·é€²æ™‚æ‰£
                const stockTax = record.type === 'å¤š' 
                    ? (x * units * 1000 * 0.003)  // å¤šå–®è³£å‡ºæ™‚æ‰£
                    : (e * units * 1000 * 0.003); // ç©ºå–®è²·é€²æ™‚æ‰£
                
                return (diff * 1000 * units) - commissionFee - stockTax;
            }
        }

        function getRankClass(rank) {
            if (rank === 'é‡‘å–®') return 'rank-gold';
            if (rank === 'éŠ€å–®') return 'rank-silver';
            if (rank === 'éŠ…å–®') return 'rank-bronze';
            if (rank === 'ç„¡') return 'rank-none';
            return 'bg-dark text-secondary border';
        }

        const stockMap = { "2330": "å°ç©é›»", "2317": "é´»æµ·", "2454": "è¯ç™¼ç§‘", "2303": "è¯é›»", "2603": "é•·æ¦®", "2881": "å¯Œé‚¦é‡‘", "3231": "ç·¯å‰µ", "2382": "å»£é”", "7791": "çš‡å®¶å¯å£", "6217": "ä¸­æ¢é‡", "3374": "ç²¾æ", "2731": "é›„ç…", "2301": "å…‰å¯¶ç§‘", "2363": "çŸ½çµ±", "6517": "ä¿å‹å…‰å­¸", "1503": "å£«é›»", "6266": "å‡Œè¯", "3036": "æ–‡æ›„", "2543": "çš‡æ˜Œ", "6227": "èŒ‚ç¶¸", "3037": "æ¬£èˆˆ", "2464": "ç›Ÿç«‹", "6257": "çŸ½æ ¼", "2727": "ç‹å“", "3706": "ç¥é”", "2354": "é´»æº–" };

        /** 3. æ¸²æŸ“èˆ‡è·¯ç”± **/
        window.currentFilter = 'å…¨éƒ¨';
        window.currentSort = null;
        window.navigateTo = (page, params = null) => {
            const container = document.getElementById('app-container');
            container.innerHTML = '';
            container.style.opacity = '1';
            switch(page) {
                case 'home': renderHome(container); break;
                case 'details': window.currentMarket = params; renderDetails(container, params, window.currentFilter); break;
                case 'strategy': renderStrategy(container); break;
                case 'form': renderForm(container, params.type, params.id); break;
            }
            window.scrollTo(0, 0);
        };

        function renderHome(container) {
            container.innerHTML = `
                <div class="page-transition">
                    <div class="mb-14 mt-4">
                        <h2 class="h2 fw-black text-white">æ•¸æ“šå„€è¡¨æ¿</h2>
                        <p class="fs-5 text-secondary mt-3 fw-bold" style="font-style: italic;">æŒæ¡è¶¨å‹¢ï¼Œç²¾æº–åŸ·è¡Œ</p>
                    </div>
                    <div class="row mb-5">
                        <div class="col-md-3 mb-3">
                            <div class="card card-stock card-hover rounded-4xl p-5 text-white h-100" onclick="navigateTo('details', 'stock')" style="cursor: pointer;">
                                <i class="fas fa-chart-line mb-4" style="font-size: 3.75rem;"></i>
                                <h3 class="h4 fw-black">å°è‚¡å¸‚å ´ç´€éŒ„</h3>
                                <p class="mb-0 fw-bold" style="opacity: 0.8;">Stock Records</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card card-gold card-hover rounded-4xl p-5 text-white h-100" onclick="navigateTo('details', 'gold')" style="cursor: pointer;">
                                <i class="fas fa-coins mb-4" style="font-size: 3.75rem;"></i>
                                <h3 class="h4 fw-black">é»ƒé‡‘å¸‚å ´ç´€éŒ„</h3>
                                <p class="mb-0 fw-bold" style="opacity: 0.8;">XAUUSD Records</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card card-euro card-hover rounded-4xl p-5 text-white h-100" onclick="navigateTo('details', 'euro')" style="cursor: pointer;">
                                <i class="fas fa-euro-sign mb-4" style="font-size: 3.75rem;"></i>
                                <h3 class="h4 fw-black">æ­å…ƒå¸‚å ´ç´€éŒ„</h3>
                                <p class="mb-0 fw-bold" style="opacity: 0.8;">EURUSD Records</p>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="card card-strategy card-hover rounded-4xl p-5 text-white h-100" onclick="navigateTo('strategy')" style="cursor: pointer;">
                                <i class="fas fa-shield-halved mb-4" style="font-size: 3.75rem; color: #e9d5ff;"></i>
                                <h3 class="h4 fw-black">äº¤æ˜“ç­–ç•¥æ¡†æ¶</h3>
                                <p class="mb-0 fw-bold" style="opacity: 0.8;">Core Strategy</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-dark border rounded-4xl p-4 d-flex flex-column flex-md-row justify-content-between gap-3 align-items-center">
                        <div class="flex-grow-1 text-secondary small">
                            <div class="fw-black text-light mb-1">äº¤æ˜“ç´€éŒ„å‚™ä»½èˆ‡é‚„åŸ</div>
                            <div>åŒ¯å‡ºç›®å‰æ‰€æœ‰å°è‚¡ / é»ƒé‡‘ / æ­å…ƒ / å¿ƒå¾—ç´€éŒ„ç‚º JSON æª”ï¼Œæ—¥å¾Œå¯åœ¨å…¶ä»–ç€è¦½å™¨åŒ¯å…¥é‚„åŸã€‚</div>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" onclick="exportTradingData()" class="btn btn-success fw-bold">
                                <i class="fas fa-download me-2"></i>åŒ¯å‡ºå‚™ä»½
                            </button>
                            <label class="btn btn-dark fw-bold border" style="cursor: pointer;">
                                <i class="fas fa-upload me-2"></i>åŒ¯å…¥å‚™ä»½
                                <input type="file" accept=".json,application/json" class="d-none" onchange="importTradingData(this.files[0]); this.value='';">
                            </label>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDetails(container, marketType, filter = 'å…¨éƒ¨', sort = null) {
            window.currentFilter = filter;
            window.currentSort = sort;
            window.currentMarketType = marketType;
            const data = tradingData[marketType] || [];
            const settledAll = data.filter(d => d.exitPrice && d.exitPrice.toString().trim() !== "");
            const winsAll = settledAll.filter(d => determineResult(d.type, d.entryPrice, d.exitPrice) === 'ç²åˆ©').length;
            const winRate = settledAll.length > 0 ? ((winsAll / settledAll.length) * 100).toFixed(1) : '0.0';

            let totalR = 0, totalPnL = 0;
            settledAll.forEach(d => {
                totalR += calculateFinalRR(d.type, d.entryPrice, d.sl, d.exitPrice);
                totalPnL += calculatePnL(d, marketType);
            });

            let filteredData = data;
            if (filter === 'æœªçµå–®') filteredData = data.filter(d => !d.exitPrice || d.exitPrice.toString().trim() === "");
            else if (filter === 'ç²åˆ©å–®') filteredData = data.filter(d => d.exitPrice && determineResult(d.type, d.entryPrice, d.exitPrice) === 'ç²åˆ©');
            else if (filter === 'è™§æå–®') filteredData = data.filter(d => d.exitPrice && determineResult(d.type, d.entryPrice, d.exitPrice) === 'è™§æ');
            else filteredData = data; // å…¨éƒ¨
            
            // æŒ‰å¤šç©ºæ’åº
            if (sort === 'long') filteredData = filteredData.filter(d => d.type === 'å¤š');
            else if (sort === 'short') filteredData = filteredData.filter(d => d.type === 'ç©º');

            const pnlUnit = (marketType === 'gold' || marketType === 'euro') ? 'USD' : 'TWD';
            const marketLabel = marketType === 'gold' ? 'é»ƒé‡‘ XAUUSD' : (marketType === 'euro' ? 'æ­å…ƒ EURUSD' : 'å°è‚¡å¸‚å ´');

            container.innerHTML = `
                <div class="page-transition">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-end mb-5 gap-4">
                        <div>
                            <button onclick="navigateTo('home')" class="btn btn-link text-secondary mb-3 p-0 fw-black">
                                <i class="fas fa-chevron-left me-2"></i> è¿”å›é¦–é 
                            </button>
                            <h2 class="h3 fw-black text-white">${marketLabel}</h2>
                        </div>
                        <button onclick="navigateTo('form', {type: '${marketType}'})" class="btn-primary-custom d-flex align-items-center gap-2">
                            <i class="fas fa-plus"></i> æ–°å¢ç´€éŒ„
                        </button>
                    </div>

                    <div class="row mb-4">
                        <div class="col-sm-6 col-md-3 mb-3">
                            <div class="stat-box">
                                <div class="stat-label">æ•´é«”å‹ç‡çµ±è¨ˆ</div>
                                <div class="stat-value text-primary">${winRate}%</div>
                                <p class="text-secondary small mt-2 mb-0">å·²çµå–®å‹ç‡</p>
                            </div>
                        </div>
                        <div class="col-sm-6 col-md-3 mb-3">
                            <div class="stat-box">
                                <div class="stat-label">å¤šå–®å‹ç‡</div>
                                <div class="stat-value text-info">${(() => {
                                    const longSettled = settledAll.filter(d => d.type === 'å¤š');
                                    const longWins = longSettled.filter(d => determineResult(d.type, d.entryPrice, d.exitPrice) === 'ç²åˆ©').length;
                                    return longSettled.length > 0 ? ((longWins / longSettled.length) * 100).toFixed(1) : '0.0';
                                })()}%</div>
                                <p class="text-secondary small mt-2 mb-0">ğŸ“ˆ Long Position</p>
                            </div>
                        </div>
                        <div class="col-sm-6 col-md-3 mb-3">
                            <div class="stat-box">
                                <div class="stat-label">ç©ºå–®å‹ç‡</div>
                                <div class="stat-value text-warning">${(() => {
                                    const shortSettled = settledAll.filter(d => d.type === 'ç©º');
                                    const shortWins = shortSettled.filter(d => determineResult(d.type, d.entryPrice, d.exitPrice) === 'ç²åˆ©').length;
                                    return shortSettled.length > 0 ? ((shortWins / shortSettled.length) * 100).toFixed(1) : '0.0';
                                })()}%</div>
                                <p class="text-secondary small mt-2 mb-0">ğŸ“‰ Short Position</p>
                            </div>
                        </div>
                        <div class="col-sm-6 col-md-3 mb-3">
                            <div class="stat-box">
                                <div class="stat-label">ç¸½è¨ˆå–®æ•¸ç´¯è¨ˆ</div>
                                <div class="stat-value">${data.length}</div>
                                <p class="text-secondary small mt-2 mb-0">å…¨éƒ¨äº¤æ˜“</p>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-sm-6 col-md-4 mb-3">
                            <div class="stat-box">
                                <div class="stat-label">ç¸½ R æ•¸</div>
                                <div class="stat-value ${totalR >= 0 ? 'text-success' : 'text-danger'}">${totalR.toFixed(1)} R</div>
                                <p class="text-secondary small mt-2 mb-0">ç´¯ç©å¯¦éš› Rï¼ˆå·²çµå–®ï¼‰</p>
                            </div>
                        </div>
                        <div class="col-sm-6 col-md-4 mb-3">
                            <div class="stat-box">
                                <div class="stat-label">å¤šå–® R æ•¸</div>
                                <div class="stat-value ${(() => {
                                    const longR = settledAll.filter(d => d.type === 'å¤š').reduce((acc, d) => acc + calculateFinalRR(d.type, d.entryPrice, d.sl, d.exitPrice), 0);
                                    return longR >= 0 ? 'text-success' : 'text-danger';
                                })()}">
                                ${(() => {
                                    const longR = settledAll.filter(d => d.type === 'å¤š').reduce((acc, d) => acc + calculateFinalRR(d.type, d.entryPrice, d.sl, d.exitPrice), 0);
                                    return longR.toFixed(1);
                                })()}</div>
                                <p class="text-secondary small mt-2 mb-0">ğŸ“ˆ å¤šé ­ç´¯è¨ˆ</p>
                            </div>
                        </div>
                        <div class="col-sm-6 col-md-4 mb-3">
                            <div class="stat-box">
                                <div class="stat-label">ç©ºå–® R æ•¸</div>
                                <div class="stat-value ${(() => {
                                    const shortR = settledAll.filter(d => d.type === 'ç©º').reduce((acc, d) => acc + calculateFinalRR(d.type, d.entryPrice, d.sl, d.exitPrice), 0);
                                    return shortR >= 0 ? 'text-success' : 'text-danger';
                                })()}">
                                ${(() => {
                                    const shortR = settledAll.filter(d => d.type === 'ç©º').reduce((acc, d) => acc + calculateFinalRR(d.type, d.entryPrice, d.sl, d.exitPrice), 0);
                                    return shortR.toFixed(1);
                                })()}</div>
                                <p class="text-secondary small mt-2 mb-0">ğŸ“‰ ç©ºé ­ç´¯è¨ˆ</p>
                            </div>
                        </div>
                    </div>

                    <div class="row mb-4">
                        <div class="col-sm-6 col-md-6 mb-3">
                            <div class="stat-box">
                                <div class="stat-label">å¯¦éš›ç›ˆè™§</div>
                                <div class="stat-value ${totalPnL >= 0 ? 'text-primary' : 'text-danger'}">${totalPnL.toFixed(2)} ${pnlUnit}</div>
                                <p class="text-secondary small mt-2 mb-0">ä¾å–®ä½èˆ‡åƒ¹å·®æ›ç®—</p>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2 mb-4 scrollbar-hide flex-wrap" style="overflow-x: auto; padding-bottom: 0.5rem;">
                        ${['å…¨éƒ¨', 'æœªçµå–®', 'ç²åˆ©å–®', 'è™§æå–®'].map(f => {
                            let count = 0;
                            if (f === 'å…¨éƒ¨') count = data.length;
                            else if (f === 'æœªçµå–®') count = data.filter(d => !d.exitPrice || d.exitPrice.toString().trim() === "").length;
                            else if (f === 'ç²åˆ©å–®') count = data.filter(d => d.exitPrice && determineResult(d.type, d.entryPrice, d.exitPrice) === 'ç²åˆ©').length;
                            else if (f === 'è™§æå–®') count = data.filter(d => d.exitPrice && determineResult(d.type, d.entryPrice, d.exitPrice) === 'è™§æ').length;
                            return `
                            <button onclick="renderDetails(document.getElementById('app-container'), '${marketType}', '${f}', null)"
                                    class="input-tab ${filter === f && !sort ? 'active' : 'inactive'}" style="white-space: nowrap;">
                                ${f}ï¼ˆ${count}ï¼‰
                            </button>
                        `;
                        }).join('')}
                        <div style="width: 100%; height: 2px; background: #334155; margin: 0 0 -0.5rem 0; flex-basis: 100%;"></div>
                        <button onclick="renderDetails(document.getElementById('app-container'), '${marketType}', '${filter}', null)"
                                class="input-tab ${!window.currentSort ? 'active' : 'inactive'}" style="white-space: nowrap; font-size: 0.75rem;">
                            å…¨éƒ¨
                        </button>
                        <button onclick="renderDetails(document.getElementById('app-container'), '${marketType}', '${filter}', 'long')"
                                class="input-tab ${window.currentSort === 'long' ? 'active' : 'inactive'}" style="white-space: nowrap; font-size: 0.75rem;">
                            ğŸ“ˆ å¤šå–®
                        </button>
                        <button onclick="renderDetails(document.getElementById('app-container'), '${marketType}', '${filter}', 'short')"
                                class="input-tab ${window.currentSort === 'short' ? 'active' : 'inactive'}" style="white-space: nowrap; font-size: 0.75rem;">
                            ğŸ“‰ ç©ºå–®
                        </button>
                    </div>

                    <div class="space-y-4">
                        ${filteredData.map(item => {
                            const result = determineResult(item.type, item.entryPrice, item.exitPrice);
                            const isSettled = item.exitPrice && item.exitPrice.toString().trim() !== "";
                            const finalR = calculateFinalRR(item.type, item.entryPrice, item.sl, item.exitPrice);
                            const pnl = calculatePnL(item, marketType);
                            return `
                            <div class="bg-dark border rounded-4xl p-5 mb-3 overflow-hidden" style="border-color: #334155;">
                                <div class="d-flex justify-content-between align-items-start mb-4">
                                    <div>
                                        <div class="d-flex align-items-center gap-3 mb-2 flex-wrap">
                                            <span class="small text-secondary">${item.date}</span>
                                            <span class="px-2 py-1 rounded small fw-bold ${getRankClass(item.rank)}">${item.rank || 'æœªåˆ†ç´š'}</span>
                                            <span class="score-badge">Score: ${calculateTradeScore(item)}</span>
                                            <span class="small fw-black ${isSettled ? 'text-info' : 'text-warning'}">
                                                ${isSettled ? 'å·²çµå–®' : 'æŒå€‰ä¸­'}
                                            </span>
                                        </div>
                                        <h3 class="h5 fw-black text-white mb-0">${item.item} <span class="${item.type === 'å¤š' ? 'text-primary fw-black' : 'text-danger fw-black'} badge" style="background: ${item.type === 'å¤š' ? 'rgba(37, 99, 235, 0.2)' : 'rgba(220, 38, 38, 0.2)'};">[${item.type === 'å¤š' ? 'ğŸ“ˆ å¤šå–®' : 'ğŸ“‰ ç©ºå–®'}]</span></h3>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button onclick="navigateTo('form', {type: '${marketType}', id: '${item.id}'})" class="btn btn-link text-secondary p-2"><i class="fas fa-edit"></i></button>
                                        <button onclick="openDeleteModal('${marketType}', '${item.id}')" class="btn btn-link text-danger p-2"><i class="fas fa-trash-can"></i></button>
                                    </div>
                                </div>
                                <div class="row gap-4 mb-3">
                                    <div class="col text-center">
                                        <p class="small text-secondary fw-bold mb-1 text-uppercase">é€²å ´ / å–®ä½</p>
                                        <p class="font-monospace fw-black text-light">${item.entryPrice} / ${item.units} ${(marketType === 'gold' || marketType === 'euro') ? 'æ‰‹' : 'å¼µ'}</p>
                                    </div>
                                    <div class="col text-center">
                                        <p class="small text-secondary fw-bold mb-1 text-uppercase">å‡ºå ´åƒ¹æ ¼</p>
                                        <p class="font-monospace fw-black text-info">${item.exitPrice || '-'}</p>
                                    </div>
                                    <div class="col text-center">
                                        <p class="small text-secondary fw-bold mb-1 text-uppercase">å¯¦éš› R æ•¸</p>
                                        <p class="font-monospace fw-black text-primary">${isSettled ? finalR.toFixed(1) : '-'}</p>
                                    </div>
                                    <div class="col text-center">
                                        <p class="small text-secondary fw-bold mb-1 text-uppercase">åˆ¤å®šçµæœ</p>
                                        <p class="fw-black ${result === 'ç²åˆ©' ? 'text-primary' : (result === 'è™§æ' ? 'text-danger' : 'text-secondary')}">${result}</p>
                                    </div>
                                    <div class="col text-center">
                                        <p class="small text-secondary fw-bold mb-1 text-uppercase">å¯¦éš›æç›Š</p>
                                        <p class="fw-black ${pnl >= 0 ? 'text-primary' : 'text-danger'}">${isSettled ? pnl.toFixed(2) + ' ' + pnlUnit : '-'}</p>
                                    </div>
                                </div>
                                <div class="d-flex flex-wrap gap-2 mb-3">
                                    ${(item.conditions || []).map(c => `<span class="badge bg-primary opacity-75">${c}</span>`).join('')}
                                    ${item.fundamental ? `<span class="badge bg-success">åŸºæœ¬é¢åŠ åˆ†</span>` : ''}
                                    ${item.news ? `<span class="badge bg-warning text-dark">æ¶ˆæ¯é¢åŠ åˆ†</span>` : ''}
                                </div>
                                <div class="bg-secondary bg-opacity-25 p-3 rounded-3xl border border-secondary border-opacity-25">
                                    <strong class="text-light fw-black">å›æ¸¬èˆ‡åæ€ï¼š</strong> 
                                    <span class="text-secondary">${item.reflection || 'ç„¡å‚™è¨»'}</span>
                                </div>
                            </div>
                        `;}).join('')}
                    </div>
                </div>
            `;
        }

        function renderForm(container, marketType, id = undefined) {
            const isEdit = typeof id === 'string' && id !== '';
            const isGoldOrEuro = marketType === 'gold' || marketType === 'euro';
            let record = isEdit
                ? tradingData[marketType].find(r => r.id === id)
                : {
                    id: Date.now().toString(),
                    date: new Date().toISOString().split('T')[0],
                    item: isGoldOrEuro ? (marketType === 'gold' ? 'é»ƒé‡‘ XAUUSD' : 'æ­å…ƒ EURUSD') : '',
                    type: 'å¤š',
                    rank: '',
                    entryPrice: '',
                    units: isGoldOrEuro ? '0.01' : '1',
                    tp: '',
                    sl: '',
                    exitPrice: '',
                    conditions: [],
                    fundamental: false,
                    news: false,
                    reflection: ''
                };

            container.innerHTML = `
                <div class="page-transition mb-5">
                    <button onclick="navigateTo('details', '${marketType}')" class="btn btn-link text-secondary mb-4 p-0 fw-black">
                        <i class="fas fa-chevron-left me-2"></i> å–æ¶ˆä¸¦è¿”å›
                    </button>
                    <div class="bg-dark border rounded-4xl overflow-hidden">
                        <div class="bg-secondary bg-opacity-25 px-5 py-4 border-bottom text-center">
                            <h2 class="h4 fw-black text-white mb-0">${isEdit ? 'ç·¨è¼¯' : 'æ–°å¢'} ${isGoldOrEuro ? (marketType === 'gold' ? 'é»ƒé‡‘' : 'æ­å…ƒ') : 'å°è‚¡'} ç´€éŒ„</h2>
                        </div>
                        <form id="trading-form" class="p-5">
                            <div class="row mb-4">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">é€²å ´æ—¥æœŸ</label>
                                    <input type="date" name="date" value="${record.date}" class="form-control" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">äº¤æ˜“æ¨™çš„</label>
                                    ${
                                        !isGoldOrEuro
                                        ? `
                                        <div class="d-flex gap-2 mb-2">
                                            <button type="button" id="tab-auto" class="input-tab active" onclick="switchInputMethod('auto')">è‡ªå‹•è¼¸å…¥</button>
                                            <button type="button" id="tab-manual" class="input-tab inactive" onclick="switchInputMethod('manual')">æ‰‹å‹•è¼¸å…¥</button>
                                        </div>
                                        <div id="auto-lookup-box">
                                            <input type="text" placeholder="ä¾‹å¦‚ï¼š2330" class="form-control" oninput="lookupStockId(this.value)">
                                            <p id="auto-lookup-result" class="mt-2 small text-info fw-bold">è‡ªå‹•åŒ¹é…åç¨±</p>
                                            <input type="hidden" id="item-hidden-input" name="item" value="${record.item}">
                                        </div>
                                        <div id="manual-input-box" class="d-none">
                                            <input type="text" class="form-control" placeholder="æ‰‹å‹•æ¨™çš„åç¨±" value="${record.item}" oninput="document.getElementById('item-hidden-input').value = this.value">
                                        </div>`
                                        : `
                                        <input type="text" value="${marketType === 'gold' ? 'é»ƒé‡‘ XAUUSD' : 'æ­å…ƒ EURUSD'}" class="form-control" readonly>
                                        <input type="hidden" name="item" value="${marketType === 'gold' ? 'é»ƒé‡‘ XAUUSD' : 'æ­å…ƒ EURUSD'}">
                                        `
                                    }
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">äº¤æ˜“æ–¹å‘</label>
                                    <select name="type" id="type-select" class="form-control select-control fw-black" onchange="updateFormUI(this.value, '${marketType}')">
                                        <option value="å¤š" ${record.type === 'å¤š' ? 'selected' : ''} style="color: #2563eb;">ğŸ“ˆ å¤šå–® (Long)</option>
                                        <option value="ç©º" ${record.type === 'ç©º' ? 'selected' : ''} style="color: #dc2626;">ğŸ“‰ ç©ºå–® (Short)</option>
                                    </select>
                                </div>
                            </div>

                            <section class="mb-4">
                                <h3 class="h6 fw-black text-info mb-3 border-bottom pb-2 text-uppercase">æ ¸å¿ƒè©•åˆ†èˆ‡ç­‰ç´šæ¬Šé‡</h3>
                                <div class="row">
                                    <div class="col-md-6 mb-3" id="condition-section"></div>
                                    <div class="col-md-6 mb-3" id="rank-section"></div>
                                </div>
                                <h3 class="h6 fw-black text-info mb-3 border-bottom pb-2 text-uppercase">åŠ åˆ†é …ç›®</h3>
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <label class="d-flex align-items-center gap-3 p-3 rounded border bg-dark border-secondary cursor-pointer" style="cursor: pointer;">
                                            <input type="checkbox" name="fundamental" ${record.fundamental ? 'checked' : ''} onchange="refreshCalculations()" class="checkbox-input">
                                            <div>
                                                <div class="fw-black text-light">åŸºæœ¬é¢åŠ åˆ†</div>
                                                <small class="text-secondary">ç‡Ÿæ”¶èˆ‡è¶¨å‹¢è‰¯å¥½ +20 Pts</small>
                                            </div>
                                        </label>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label class="d-flex align-items-center gap-3 p-3 rounded border bg-dark border-secondary cursor-pointer" style="cursor: pointer;">
                                            <input type="checkbox" name="news" ${record.news ? 'checked' : ''} onchange="refreshCalculations()" class="checkbox-input">
                                            <div>
                                                <div class="fw-black text-light">æ¶ˆæ¯é¢åŠ åˆ†</div>
                                                <small class="text-secondary">é‡å¤§æ–°èæˆ–ç±Œç¢¼æ”¯æ’ +20 Pts</small>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </section>

                            <section class="mb-4">
                                <h3 class="h6 fw-black text-info mb-3 border-bottom pb-2 text-uppercase">æ•¸æ“šåˆ†æ</h3>
                                <div class="row align-items-end">
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">å–®ä½ <span class="text-secondary small">(${isGoldOrEuro ? 'æ‰‹' : 'å¼µ'})</span></label>
                                        <input type="text" name="units" value="${record.units}" class="form-control" placeholder="${isGoldOrEuro ? '0.01 æ‰‹' : '1 å¼µ'}">
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">é€²å ´åƒ¹æ ¼</label>
                                        <input type="text" id="entry-price" name="entryPrice" value="${record.entryPrice}" class="form-control" oninput="refreshCalculations()" required>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">åœåˆ© TP</label>
                                        <input type="text" id="tp-price" name="tp" value="${record.tp}" class="form-control" oninput="refreshCalculations()">
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">åœæ SL</label>
                                        <input type="text" id="sl-price" name="sl" value="${record.sl}" class="form-control" oninput="refreshCalculations()">
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label text-info fw-black">å‡ºå ´åƒ¹æ ¼ (æœ‰æ•¸å€¼å³è‡ªå‹•åˆ¤å®šçµå–®)</label>
                                    <input type="text" id="exit-price" name="exitPrice" value="${record.exitPrice}" class="form-control" placeholder="å¡«å…¥å‡ºå ´åƒ¹æ ¼" oninput="refreshCalculations()">
                                </div>

                                <div class="bg-secondary bg-opacity-10 p-4 rounded-3xl d-flex flex-column flex-md-row justify-content-between align-items-center gap-3 border">
                                    <div class="d-flex gap-4">
                                        <div>
                                            <span class="text-secondary small fw-bold text-uppercase d-block mb-1">é è¨ˆç›ˆè™§æ¯”</span>
                                            <span id="rr-preview" class="h5 fw-black text-primary">0.0 R</span>
                                        </div>
                                        <div>
                                            <span class="text-secondary small fw-bold text-uppercase d-block mb-1">åˆ¤å®šçµæœ</span>
                                            <span id="result-preview" class="h5 fw-black text-light">-</span>
                                        </div>
                                    </div>
                                    <div class="text-center">
                                        <span class="text-secondary small fw-bold text-uppercase d-block mb-1">ç¶œåˆå¾—åˆ†</span>
                                        <span id="score-preview" class="h3 fw-black text-success">0 Pts</span>
                                    </div>
                                </div>
                            </section>

                            <section class="mb-4">
                                <label class="form-label">è¤‡ç›¤èˆ‡æª¢è¨ç´€éŒ„</label>
                                <textarea name="reflection" rows="10" class="form-control textarea-large">${record.reflection}</textarea>
                            </section>

                            <div class="pt-3">
                                <button type="button" onclick="handleSave('${marketType}', '${isEdit ? record.id : ''}')" class="btn btn-primary w-100 fw-black py-3 text-uppercase">
                                    åŒæ­¥å„²å­˜äº¤æ˜“ç´€éŒ„
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            updateFormUI(record.type, marketType, record.conditions, record.rank);
            refreshCalculations();
        }

        window.updateFormUI = (tradeType, marketType, savedConds = [], savedRank = '') => {
            const condEl = document.getElementById('condition-section');
            const rankEl = document.getElementById('rank-section');

            const conds = (tradeType === 'å¤š')
                ? ['Vegasé€šé“å¾€ä¸Š', 'RSIé»ƒé‡‘äº¤å‰']
                : ['Vegasé€šé“å¾€ä¸‹', 'RSIæ­»äº¡äº¤å‰'];
                    
            condEl.innerHTML = `
                <div class="bg-dark border rounded-3xl p-3 h-100 d-flex flex-column justify-content-center">
                    <div class="d-flex flex-column gap-3 text-light fw-black">
                        ${conds.map(c => `
                            <label class="d-flex align-items-center gap-3 cursor-pointer" style="cursor: pointer;">
                                <input type="checkbox" name="conditions" value="${c}" ${savedConds.includes(c) ? 'checked' : ''} onchange="refreshCalculations()" class="checkbox-input">
                                <span>${c}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;

            const ranks = (tradeType === 'å¤š')
                ? [
                    { n: 'é‡‘å–®', d: 'VALæ’é‡' },
                    { n: 'éŠ€å–®', d: 'VAL / POC å€é–“' },
                    { n: 'éŠ…å–®', d: 'POC è™•' },
                    { n: 'ç„¡', d: 'æœªåˆ†ç´š' }
                ]
                : [
                    { n: 'é‡‘å–®', d: 'VAHæ’é‡' },
                    { n: 'éŠ€å–®', d: 'VAL / POC å€é–“' },
                    { n: 'éŠ…å–®', d: 'POC è™•' },
                    { n: 'ç„¡', d: 'æœªåˆ†ç´š' }
                ];

            rankEl.innerHTML = ranks.map(r => {
                const baseClass = r.n === 'é‡‘å–®' ? 'rank-gold' : (r.n === 'éŠ€å–®' ? 'rank-silver' : (r.n === 'éŠ…å–®' ? 'rank-bronze' : 'rank-none'));
                const selected = savedRank === r.n ? 'border-white border-3' : '';
                const textClass = (r.n === 'é‡‘å–®' || r.n === 'éŠ€å–®' || r.n === 'éŠ…å–®') ? '' : 'text-light';

                return `
                    <label class="d-flex align-items-center gap-3 p-3 rounded border-2 cursor-pointer transition mb-2 ${baseClass} ${textClass} ${selected}" style="cursor: pointer;">
                        <input type="radio" name="rank" value="${r.n}" ${savedRank === r.n ? 'checked' : ''} onchange="refreshCalculations()" class="checkbox-input">
                        <div class="flex-grow-1">
                            <div class="fw-black">${r.n}</div>
                            <small class="opacity-75">${r.d}</small>
                        </div>
                    </label>
                `;
            }).join('');
        };

        window.refreshCalculations = () => {
            const entry = document.getElementById('entry-price')?.value || '';
            const exit = document.getElementById('exit-price')?.value || '';
            const type = document.getElementById('type-select')?.value || 'å¤š';
            const tp = document.getElementById('tp-price')?.value || '';
            const sl = document.getElementById('sl-price')?.value || '';

            const res = determineResult(type, entry, exit);
            const resEl = document.getElementById('result-preview');
            if (resEl) {
                resEl.innerText = res;
                resEl.className = `h5 fw-black ${res === 'ç²åˆ©' ? 'text-danger' : (res === 'è™§æ' ? 'text-success' : 'text-light')}`;
            }

            const rrEl = document.getElementById('rr-preview');
            if (rrEl) rrEl.innerText = calculateRR(type, entry, tp, sl) + " R";

            const rank = document.querySelector('input[name="rank"]:checked')?.value;
            const conds = Array.from(document.querySelectorAll('input[name="conditions"]:checked')).map(e => e.value);
            const fundamental = document.querySelector('input[name="fundamental"]')?.checked || false;
            const news = document.querySelector('input[name="news"]')?.checked || false;

            const scoreEl = document.getElementById('score-preview');
            if (scoreEl) scoreEl.innerText = calculateTradeScore({ rank, conditions: conds, fundamental, news }) + " Pts";
        };

        let deleteTarget = { market: null, id: null };
        window.openDeleteModal = (market, id) => {
            deleteTarget = { market, id };
            document.getElementById('delete-modal').style.display = 'flex';
        };
        window.closeDeleteModal = () => document.getElementById('delete-modal').style.display = 'none';
        document.getElementById('confirm-delete-btn').addEventListener('click', () => {
            const { market, id } = deleteTarget;
            tradingData[market] = tradingData[market].filter(r => r.id !== id);
            saveData();
            closeDeleteModal();
            navigateTo('details', market);
        });

        window.handleSave = (market, idStr) => {
            const form = document.getElementById('trading-form');
            const formData = new FormData(form);
            const finalId = (idStr && idStr !== '') ? idStr : Date.now().toString();

            const record = {
                id: finalId,
                date: formData.get('date'),
                item: formData.get('item'),
                type: formData.get('type'),
                rank: formData.get('rank') || '',
                entryPrice: formData.get('entryPrice'),
                units: formData.get('units'),
                tp: formData.get('tp'),
                sl: formData.get('sl'),
                exitPrice: formData.get('exitPrice'),
                conditions: Array.from(document.querySelectorAll('input[name="conditions"]:checked')).map(e => e.value),
                fundamental: document.querySelector('input[name="fundamental"]')?.checked || false,
                news: document.querySelector('input[name="news"]')?.checked || false,
                reflection: formData.get('reflection'),
                timestamp: Date.now()
            };

            const index = tradingData[market].findIndex(r => r.id === finalId);
            if (index > -1) tradingData[market][index] = record;
            else tradingData[market].unshift(record);

            saveData();
            navigateTo('details', market);
        };

        function renderStrategy(container) {
            container.innerHTML = `
                <div class="page-transition">
                    <button onclick="navigateTo('home')" class="btn btn-link text-secondary mb-4 p-0 fw-black">
                        <i class="fas fa-chevron-left me-2"></i> è¿”å›ä¸»é 
                    </button>
                    
                    <!-- é€£çµåˆ°å¤–éƒ¨ HackMD æ–‡ä»¶ -->
                    <div class="mb-4">
                        <a href="https://hackmd.io/@1cheng1/SySoXjU6gg" target="_blank" class="btn btn-outline-info fw-bold">
                            <i class="fas fa-external-link-alt me-2"></i> æª¢è¦–å®Œæ•´ç­–ç•¥èªªæ˜ï¼ˆHackMDï¼‰
                        </a>
                    </div>

                    <div class="d-flex align-items-center gap-3 mb-4">
                        <div class="bg-primary text-white p-3 rounded-3xl">
                            <i class="fas fa-scroll h4"></i>
                        </div>
                        <div>
                            <h2 class="h3 fw-black text-white mb-0">æ ¸å¿ƒäº¤æ˜“ç­–ç•¥æ¡†æ¶</h2>
                            <p class="text-secondary fw-bold mb-0">å››å¤§æ”¯æŸ±ï¼šå¾è¶¨å‹¢åˆ°æŠ€è¡“åŸ·è¡Œ</p>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-6 mb-3">
                            <div class="bg-dark p-4 rounded-4xl border">
                                <h3 class="h6 fw-black text-info mb-3">1. è¶¨å‹¢ç¢ºèª (Trend)</h3>
                                <p class="text-secondary">ä¾æ“šå¤§æ™‚å€ Vegas é€šé“ã€‚åƒ¹æ ¼åœ¨é€šé“ä¹‹ä¸Šä¸”é€šé“å‘ä¸Šç‚ºå¤šé ­ï¼›åä¹‹ç‚ºç©ºé ­ã€‚</p>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="bg-dark p-4 rounded-4xl border">
                                <h3 class="h6 fw-black text-info mb-3">2. åŸºæœ¬é¢åŠ åˆ† (Fundamental)</h3>
                                <p class="text-secondary">è§€å¯Ÿç‡Ÿæ”¶èˆ‡æ¶ˆæ¯é¢ã€‚è‰¯å¥½çš„åŸºæœ¬é¢æ±ºå®šäº†æŒå€‰ä¿¡å¿ƒã€‚</p>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="bg-dark p-4 rounded-4xl border">
                                <h3 class="h6 fw-black text-info mb-3">3. æ¶ˆæ¯é¢åŠ åˆ† (News)</h3>
                                <p class="text-secondary">é—œæ³¨åœ°ç·£æ”¿æ²»æˆ–æ³•äººç±Œç¢¼ï¼Œæ¶ˆæ¯é¢å¸¸æ˜¯è„«é›¢æˆæœ¬å€çš„è§¸åª’ã€‚</p>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="bg-dark p-4 rounded-4xl border">
                                <h3 class="h6 fw-black text-info mb-3">4. æŠ€è¡“åŸ·è¡Œ (Technical)</h3>
                                <p class="text-secondary">ä¾æ“š VP ç­‰ç´šåˆ¤æ–·å…¥å ´ï¼Œçµåˆ RSI äº¤å‰æ‰£æ¿æ©Ÿã€‚åš´æ ¼åŸ·è¡Œ TP/SLã€‚</p>
                            </div>
                        </div>
                    </div>

                    <!-- äº¤æ˜“ç­–ç•¥è¡¨æ ¼ç‰ˆ -->
                    <div class="bg-dark p-4 rounded-4xl border mt-4 mb-4">
                        <h3 class="h6 fw-black text-info mb-3"><i class="fas fa-table me-2"></i>äº¤æ˜“ç­–ç•¥è¡¨æ ¼ç‰ˆï¼ˆ7æ­¥é©Ÿæµç¨‹ï¼‰</h3>
                        <div class="table-responsive">
                            <table class="table table-dark table-sm mb-0">
                                <thead>
                                    <tr class="border-bottom" style="border-color: #475569;">
                                        <th class="text-info fw-black">æ­¥é©Ÿ</th>
                                        <th class="text-info fw-black">é …ç›®</th>
                                        <th class="text-info fw-black">å¤šå–®ç­–ç•¥ (Long)</th>
                                        <th class="text-info fw-black">ç©ºå–®ç­–ç•¥ (Short)</th>
                                    </tr>
                                </thead>
                                <tbody class="text-secondary small">
                                    <tr class="border-bottom" style="border-color: #334155;">
                                        <td class="fw-bold">1</td>
                                        <td class="fw-bold">æ™‚é–“æ¡†æ¶(4å°æ™‚èˆ‡1å°æ™‚)</td>
                                        <td>4H è§€å¯Ÿ + 1H é€²å ´ï¼ˆç¦æ­¢æ¶é€²ï¼‰</td>
                                        <td>4H è§€å¯Ÿ + 1H é€²å ´ï¼ˆç¦æ­¢æ¶é€²ï¼‰</td>
                                    </tr>
                                    <tr class="border-bottom" style="border-color: #334155;">
                                        <td class="fw-bold">2</td>
                                        <td class="fw-bold">è¶¨å‹¢ç¢ºèª(4å°æ™‚èˆ‡1å°æ™‚)</td>
                                        <td>EMA144 &gt; 233 &gt; 377 &gt; 610 &gt; 987</td>
                                        <td>EMA144 &lt; 233 &lt; 377 &lt; 610 &lt; 987</td>
                                    </tr>
                                    <tr class="border-bottom" style="border-color: #334155;">
                                        <td class="fw-bold">3</td>
                                        <td class="fw-bold">VPé€²å ´ä½ç½®(1å°æ™‚)</td>
                                        <td>1. VAL æˆ–VALé™„è¿‘(2å–®ä½)<br>2. POCæˆ–POCå€é–“(1å–®ä½)</td>
                                        <td>1. VAH æˆ–VALé™„è¿‘(2å–®ä½)<br>2. æˆ–POCæˆ–POCå€é–“(1å–®ä½)</td>
                                    </tr>
                                    <tr class="border-bottom" style="border-color: #334155;">
                                        <td class="fw-bold">4</td>
                                        <td class="fw-bold">è§¸ç™¼è¨Šè™Ÿ(1å°æ™‚)</td>
                                        <td>RSI(6,12) é»ƒé‡‘äº¤å‰ + 4H RSI &lt;70</td>
                                        <td>RSI(6,12) æ­»äº¡äº¤å‰ + 4H RSI &gt;30</td>
                                    </tr>
                                    <tr class="border-bottom" style="border-color: #334155;">
                                        <td class="fw-bold">5</td>
                                        <td class="fw-bold">åœæè¨­å®š(1å°æ™‚)</td>
                                        <td>VAL(å›è¸©èµ·é»çš„æœ€ä½é»ä¸‹æ–¹)</td>
                                        <td>VAH(åå½ˆèµ·é»çš„æœ€é«˜é»ä¸Šæ–¹)</td>
                                    </tr>
                                    <tr class="border-bottom" style="border-color: #334155;">
                                        <td class="fw-bold">6</td>
                                        <td class="fw-bold">åœåˆ©è¨­å®š(1å°æ™‚)</td>
                                        <td>TP1: POC (å‡º1å–®ä½) | TP2: VAH (å…¨å‡º)</td>
                                        <td>TP1: POC (å‡º1å–®ä½) | TP2: VAL (å…¨å‡º)</td>
                                    </tr>
                                    <tr>
                                        <td class="fw-bold">7</td>
                                        <td class="fw-bold">åŠ å€‰æ©Ÿåˆ¶(1å°æ™‚)</td>
                                        <td>é¦–å–®ä¿æœ¬ + å†æ¬¡å‡ºç¾ 1H Vegas å›è¸© + RSI é‡‘å‰</td>
                                        <td>é¦–å–®ä¿æœ¬ + å†æ¬¡å‡ºç¾ 1H Vegas åå½ˆ + RSI æ­»å‰</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="bg-dark p-4 rounded-4xl border mt-4">
                        <h3 class="h6 fw-black text-info mb-3"><i class="fas fa-brain me-2"></i>ç¸½é«”äº¤æ˜“å¿ƒå¾—èˆ‡è§€å¯Ÿ</h3>
                        
                        <!-- é¡¯ç¤ºå€ï¼ˆåªè®€é è¦½ï¼‰ -->
                        <div class="bg-black bg-opacity-50 border border-secondary rounded-3xl p-4 mb-3">
                            <div class="small text-info fw-bold mb-2 text-uppercase">ç›®å‰å…§å®¹é è¦½</div>
                            <div id="insight-preview" class="text-light" style="white-space: pre-line; line-height: 1.8; min-height: 120px;">
                                ${(tradingData.generalInsights || '').trim() ? tradingData.generalInsights : 'å°šæœªè¼¸å…¥å…§å®¹...'}
                            </div>
                        </div>

                        <!-- è¼¸å…¥å€ï¼ˆå¯ç·¨è¼¯ï¼‰ -->
                        <textarea id="general-insights-input" class="form-control textarea-large" placeholder="åœ¨é€™è£¡è¼¸å…¥ / ä¿®æ”¹ä½ çš„å¿ƒå¾—...è¨˜éŒ„æ‚¨çš„å¸‚å ´è§€å¯Ÿã€å¿ƒæ³•ä¿®ç…‰ã€æˆ–æ˜¯å°è¿‘æœŸç­–ç•¥åŸ·è¡Œç‡çš„æª¢è¨...">${tradingData.generalInsights || ''}</textarea>
                        <div class="mt-3">
                            <button onclick="saveGeneralInsights()" class="btn btn-primary w-100 fw-black py-3 text-uppercase">
                                <i class="fas fa-save me-2"></i> å„²å­˜ç¸½é«”å¿ƒå¾—
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        window.saveGeneralInsights = () => {
            const input = document.getElementById('general-insights-input');
            const preview = document.getElementById('insight-preview');
            if (input) {
                tradingData.generalInsights = input.value;
                saveData();
                
                // ç«‹å³æ›´æ–°é è¦½å€
                const v = input.value.trim();
                preview.textContent = v || 'å°šæœªè¼¸å…¥å…§å®¹...';
                
                const btn = event.currentTarget;
                const orig = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check me-2"></i> å¿ƒå¾—å·²å„²å­˜';
                btn.classList.replace('btn-primary', 'btn-success');
                setTimeout(() => {
                    btn.innerHTML = orig;
                    btn.classList.replace('btn-success', 'btn-primary');
                }, 2000);
            }
        };

        // è¼¸å…¥æ™‚å³æ™‚åŒæ­¥é è¦½
        window.initInsightPreview = () => {
            const inputEl = document.getElementById('general-insights-input');
            const previewEl = document.getElementById('insight-preview');
            if (!inputEl || !previewEl) return;
            
            const syncPreview = () => {
                const v = inputEl.value.trim();
                previewEl.textContent = v || 'å°šæœªè¼¸å…¥å…§å®¹...';
            };
            
            inputEl.addEventListener('input', syncPreview);
        };

        window.switchInputMethod = (method) => {
            const autoBox = document.getElementById('auto-lookup-box');
            const manualBox = document.getElementById('manual-input-box');
            const autoTab = document.getElementById('tab-auto');
            const manualTab = document.getElementById('tab-manual');
            if (method === 'auto') {
                autoBox.classList.remove('d-none');
                manualBox.classList.add('d-none');
                autoTab.classList.add('active');
                autoTab.classList.remove('inactive');
                manualTab.classList.remove('active');
                manualTab.classList.add('inactive');
            } else {
                autoBox.classList.add('d-none');
                manualBox.classList.remove('d-none');
                autoTab.classList.remove('active');
                autoTab.classList.add('inactive');
                manualTab.classList.add('active');
                manualTab.classList.remove('inactive');
            }
        };

        window.lookupStockId = (id) => {
            const display = document.getElementById('auto-lookup-result');
            const hiddenInput = document.getElementById('item-hidden-input');
            if (stockMap[id]) {
                display.innerText = `æ‰¾åˆ°æ¨™çš„ï¼š${stockMap[id]}`;
                display.className = "mt-2 small text-info fw-bold";
                hiddenInput.value = `${stockMap[id]} ${id}`;
            } else {
                display.innerText = id.length >= 4 ? "æŸ¥ç„¡ä»£è™Ÿï¼Œè«‹ä½¿ç”¨æ‰‹å‹•è¼¸å…¥" : "è«‹è¼¸å…¥ 4 ç¢¼ä»£è™Ÿ";
                display.className = "mt-2 small text-secondary fw-bold";
                hiddenInput.value = "";
            }
        };

        window.onload = () => {
            navigateTo('home');
            // å»¶é²åˆå§‹åŒ–ä»¥ç¢ºä¿ DOM å·²æº–å‚™å°±ç·’
            setTimeout(() => initInsightPreview(), 100);
        };

        // ç•¶å°èˆªåˆ° strategy é é¢æ™‚ï¼Œé‡æ–°åˆå§‹åŒ–é è¦½åŒæ­¥
        const originalNavigateTo = window.navigateTo;
        window.navigateTo = (page, params = null) => {
            originalNavigateTo(page, params);
            if (page === 'strategy') {
                setTimeout(() => initInsightPreview(), 100);
            }
        };
    </script>
</body>
</html>
