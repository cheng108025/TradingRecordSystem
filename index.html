<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人交易追蹤系統</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        :root { font-size: 18px; }
        
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            line-height: 1.6; 
            background-color: #020617;
            color: #f1f5f9;
        }

        .card-stock { background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%); }
        .card-gold { background: linear-gradient(135deg, #78350f 0%, #b45309 100%); }
        .card-strategy { background: linear-gradient(135deg, #4c1d95 0%, #7c3aed 100%); }
        
        .glass-effect { 
            background: rgba(15, 23, 42, 0.95); 
            backdrop-filter: blur(20px); 
            border-bottom: 2px solid rgba(51, 65, 85, 0.5);
        }

        .page-transition { animation: none; }

        /* 輸入框：白底黑字設計 */
        .form-input { 
            width: 100%;
            padding: 0.875rem 1.25rem;
            border-radius: 1rem;
            border: 2px solid #cbd5e1;
            background-color: white;
            transition: all 0.15s;
            font-size: 1.125rem;
            font-weight: 500;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            color: #000000 !important;
        }
        .form-input::placeholder { color: #94a3b8; }
        .form-input:focus { 
            border-color: #3b82f6;
            outline: none;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1), 0 0 0 4px rgba(59,130,246,0.2);
        }
        .form-label { 
            display: block;
            font-size: 1rem;
            font-weight: 900;
            color: #e2e8f0;
            margin-bottom: 0.625rem;
        }
        
        .checkbox-card { 
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            border-radius: 1rem;
            border: 2px solid #1e293b;
            background-color: rgba(15, 23, 42, 0.6);
            cursor: pointer;
            transition: all 0.15s;
        }
        .checkbox-card:hover { background-color: #1e293b; }
        .checkbox-card input { 
            width: 1.5rem;
            height: 1.5rem;
            accent-color: #2563eb;
        }

        /* 金銀銅等級色彩強化 */
        .rank-gold { 
            background: #fbbf24 !important;
            color: black !important;
            border: 1px solid #fcd34d !important;
            box-shadow: 0 0 15px rgba(250, 204, 21, 0.4);
        }
        .rank-silver { 
            background: #cbd5e1 !important;
            color: black !important;
            border: 1px solid #f1f5f9 !important;
            box-shadow: 0 0 15px rgba(203, 213, 225, 0.3);
        }
        .rank-bronze { 
            background: #b45309 !important;
            color: white !important;
            border: 1px solid #f97316 !important;
            box-shadow: 0 0 15px rgba(234, 88, 12, 0.3);
        }

        .score-badge { 
            padding: 0.375rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 900;
            background-color: #2563eb;
            color: white;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        
        .input-tab { 
            padding: 0.5rem 1.25rem;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            font-weight: 900;
            border: 2px solid;
            transition: all 0.15s;
            cursor: pointer;
        }
        .input-tab.active { 
            background-color: white;
            border-color: white;
            color: black;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .input-tab.inactive { 
            background-color: #1e293b;
            border-color: #334155;
            color: #64748b;
        }

        #delete-modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            align-items: center;
            justify-content: center;
        }

        select.form-input {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23334155'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.2em;
            padding-right: 2rem;
        }
        
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="min-h-screen pb-12">

    <!-- 刪除確認視窗 -->
    <div id="delete-modal">
        <div class="bg-slate-900 border-2 border-slate-800 p-8 rounded-[3rem] max-w-md w-full mx-4 shadow-2xl">
            <div class="text-red-500 text-5xl mb-6 text-center">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="text-2xl font-black text-white text-center mb-4">確定永久刪除？</h3>
            <p class="text-slate-400 text-center mb-8">此操作無法復原，該筆交易紀錄將從本地儲存空間移除。</p>
            <div class="flex gap-4">
                <button onclick="closeDeleteModal()" class="flex-1 py-4 rounded-2xl bg-slate-800 text-white font-bold hover:bg-slate-700 transition-all">取消</button>
                <button id="confirm-delete-btn" class="flex-1 py-4 rounded-2xl bg-red-600 text-white font-bold hover:bg-red-500 transition-all shadow-lg">確定刪除</button>
            </div>
        </div>
    </div>

    <!-- 導覽列 -->
    <nav class="glass-effect shadow-2xl sticky top-0 z-50 px-6 py-4">
        <div class="max-w-7xl mx-auto flex justify-between items-center">
            <div class="flex items-center gap-3 cursor-pointer" onclick="navigateTo('home')">
                <div class="bg-blue-600 p-2.5 rounded-2xl text-white shadow-xl">
                    <i class="fas fa-chart-line text-2xl"></i>
                </div>
                <h1 class="text-2xl font-black tracking-tighter text-white">個人交易追蹤系統</h1>
            </div>
            
            <div class="flex items-center gap-4">
                <div class="flex items-center gap-3 bg-slate-800 px-4 py-2 rounded-2xl border border-slate-700 text-slate-300">
                    <i class="fas fa-database text-sm text-blue-400"></i>
                    <span class="text-sm font-bold">本地儲存模式</span>
                </div>
            </div>
        </div>
    </nav>

    <main id="app-container" class="max-w-7xl mx-auto p-4 md:p-10">
    </main>

    <script>
        /**
         * 1. 資料管理
         */
        const STORAGE_KEY = 'vp_trading_tracker_v5_local_final';
        
        const initialData = {
            stock: [
                { id: 's1', date: '2025-01-13', item: '皇家可口 7791', type: '多', rank: '', entryPrice: '89.5', units: '1', tp: '', sl: '', exitPrice: '', conditions: [], fundamental: true, news: false, reflection: '長期看好當存股', timestamp: 1736755200000 },
                { id: 's2', date: '2025-01-13', item: '中探針 6217', type: '多', rank: '金單', entryPrice: '53.0', units: '1', tp: '58.0', sl: '50', exitPrice: '', conditions: ['Vegas通道往上', 'RSI黃金交叉'], fundamental: true, news: true, reflection: 'Vegas通道+RSI黃金交叉+VP的VAL', timestamp: 1736755200001 },
                { id: 's3', date: '2025-01-13', item: '精材 3374', type: '多', rank: '金單', entryPrice: '146.5', units: '1', tp: '154', sl: '143', exitPrice: '', conditions: ['Vegas通道往上', 'RSI黃金交叉'], fundamental: true, news: true, reflection: 'VP的POC(完美)', timestamp: 1736755200002 },
                { id: 's4', date: '2024-12-05', item: '中探針 6217', type: '多', rank: '銀單', entryPrice: '51.3', units: '1', tp: '56.2', sl: '48', exitPrice: '', conditions: ['Vegas通道往上', 'RSI黃金交叉'], fundamental: true, news: false, reflection: 'VAL與POC之間', timestamp: 1733356800000 },
                { id: 's5', date: '2025-12-31', item: '雄獅 2731', type: '多', rank: '銅單', entryPrice: '164.5', units: '1', tp: '172', sl: '147', exitPrice: '', conditions: ['Vegas通道往上', 'RSI黃金交叉'], fundamental: true, news: false, reflection: '', timestamp: 1767139200000 },
                { id: 's6', date: '2025-01-08', item: '光寶科 2301', type: '多', rank: '銀單', entryPrice: '161', units: '1', tp: '177', sl: '147', exitPrice: '', conditions: ['Vegas通道往上', 'RSI黃金交叉'], fundamental: true, news: false, reflection: 'VAL到POC之間', timestamp: 1736294400000 },
                { id: 's7', date: '2025-01-10', item: '矽統 2363', type: '多', rank: '金單', entryPrice: '56.2', units: '1', tp: '59', sl: '56', exitPrice: '56.9', conditions: ['Vegas通道往上', 'RSI黃金交叉'], fundamental: true, news: false, reflection: '當沖沖掉，沒跌破VAL', timestamp: 1736467200000 },
                { id: 's8', date: '2025-01-10', item: '矽統 2363', type: '多', rank: '金單', entryPrice: '56.2', units: '1', tp: '61.2', sl: '55.1', exitPrice: '58', conditions: ['Vegas通道往上', 'RSI黃金交叉'], fundamental: true, news: false, reflection: '換成中探針', timestamp: 1736467200001 },
                { id: 's9', date: '2025-01-10', item: '保勝光學 6517', type: '空', rank: '銀單', entryPrice: '66.6', units: '1', tp: '65.3', sl: '67.8', exitPrice: '65.7', conditions: ['Vegas通道往下', 'RSI死亡交叉'], fundamental: false, news: false, reflection: '差點到目標就噴上去', timestamp: 1736467200002 },
                { id: 's10', date: '2025-01-10', item: '光寶科 2301', type: '多', rank: '銅單', entryPrice: '168', units: '1', tp: '174', sl: '164', exitPrice: '170.5', conditions: ['Vegas通道往上', 'RSI黃金交叉'], fundamental: false, news: false, reflection: '跌破171大量套保出掉', timestamp: 1736467200003 },
                { id: 's11', date: '2025-01-10', item: '士電 1503', type: '空', rank: '銅單', entryPrice: '176.5', units: '1', tp: '178', sl: '173.5', exitPrice: '175.5', conditions: ['Vegas通道往下', 'RSI死亡交叉'], fundamental: false, news: false, reflection: '當沖沖掉', timestamp: 1736467200004 },
                { id: 's12', date: '2025-01-11', item: '凌華 6266', type: '空', rank: '銅單', entryPrice: '61.2', units: '1', tp: '60.5', sl: '61.5', exitPrice: '60.7', conditions: ['Vegas通道往下', 'RSI死亡交叉'], fundamental: false, news: false, reflection: '', timestamp: 1736553600000 },
                { id: 's13', date: '2025-01-11', item: '文曄 3036', type: '多', rank: '銅單', entryPrice: '139.5', units: '1', tp: '143', sl: '132', exitPrice: '140.5', conditions: ['Vegas通道往上', 'RSI黃金交叉'], fundamental: false, news: false, reflection: '', timestamp: 1736553600001 },
                { id: 's14', date: '2025-01-11', item: '皇昌 2543', type: '空', rank: '銅單', entryPrice: '70.1', units: '1', tp: '69.0', sl: '70.8', exitPrice: '69.4', conditions: ['Vegas通道往下', 'RSI死亡交叉'], fundamental: false, news: false, reflection: '預估今天不會到VAL，提早平倉', timestamp: 1736553600002 },
                { id: 's15', date: '2025-01-12', item: '茂綸 6227', type: '空', rank: '銅單', entryPrice: '90', units: '1', tp: '87.8', sl: '91', exitPrice: '89.4', conditions: ['Vegas通道往下', 'RSI死亡交叉'], fundamental: false, news: false, reflection: '台股當沖空單摸索中', timestamp: 1736640000000 },
                { id: 's16', date: '2025-01-12', item: '欣興 3037', type: '多', rank: '銅單', entryPrice: '163.5', units: '1', tp: '173', sl: '159', exitPrice: '173', conditions: ['Vegas通道往上', 'RSI黃金交叉'], fundamental: true, news: false, reflection: '出國賣掉的', timestamp: 1736640000001 },
                { id: 's17', date: '2025-01-12', item: '盟立 2464', type: '空', rank: '銀單', entryPrice: '66', units: '1', tp: '64.7', sl: '66.9', exitPrice: '66.3', conditions: ['Vegas通道往下', 'RSI死亡交叉'], fundamental: false, news: false, reflection: '進場點不好，學習中', timestamp: 1736640000002 },
                { id: 's18', date: '2025-01-12', item: '緯創 3231', type: '多', rank: '銅單', entryPrice: '144.5', units: '1', tp: '152', sl: '142', exitPrice: '142', conditions: ['Vegas通道往上', 'RSI黃金交叉'], fundamental: true, news: false, reflection: '要看波段，不能看短線', timestamp: 1736640000003 },
                { id: 's19', date: '2025-01-12', item: '矽格 6257', type: '多', rank: '銅單', entryPrice: '98.5', units: '1', tp: '100', sl: '97', exitPrice: '96.9', conditions: ['Vegas通道往上', 'RSI黃金交叉'], fundamental: true, news: false, reflection: '', timestamp: 1736640000004 },
                { id: 's20', date: '2025-01-13', item: '王品 2727', type: '多', rank: '銅單', entryPrice: '223', units: '1', tp: '219', sl: '227', exitPrice: '222.5', conditions: [], fundamental: false, news: false, reflection: '研究空單打法', timestamp: 1736726400000 },
                { id: 's21', date: '2025-01-13', item: '神達 3706', type: '空', rank: '銅單', entryPrice: '93.7', units: '1', tp: '99', sl: '91.5', exitPrice: '92.1', conditions: ['Vegas通道往下', 'RSI死亡交叉'], fundamental: false, news: false, reflection: '白癡台股日內玩不了', timestamp: 1736726400001 },
                { id: 's22', date: '2025-01-13', item: '凌華 6166', type: '空', rank: '銅單', entryPrice: '60', units: '1', tp: '58', sl: '61', exitPrice: '60.3', conditions: ['Vegas通道往下', 'RSI死亡交叉'], fundamental: false, news: false, reflection: '都要等隔天', timestamp: 1736726400002 },
                { id: 's23', date: '2025-01-13', item: '鴻準 2354', type: '多', rank: '銅單', entryPrice: '70.7', units: '1', tp: '74', sl: '65', exitPrice: '63', conditions: ['Vegas通道往上', 'RSI黃金交叉'], fundamental: false, news: false, reflection: '還是玩黃金實在', timestamp: 1736726400003 },
                { id: 's24', date: '2025-12-26', item: '鴻準 2354', type: '空', rank: '銅單', entryPrice: '67.1', units: '1', tp: '60', sl: '70', exitPrice: '69', conditions: ['Vegas通道往下', 'RSI死亡交叉'], fundamental: false, news: false, reflection: '空的不好，均線交錯', timestamp: 1766707200000 },
            ],
            gold: [
                { id: 'g1', date: '2025-01-01', item: '黃金 XAUUSD', type: '空', rank: '銀單', entryPrice: '4025', units: '0.01', tp: '3919', sl: '4035', exitPrice: '4020', conditions: ['Vegas通道往下', 'RSI死亡交叉'], fundamental: false, news: true, reflection: '開會議先跑，資訊要檢查', timestamp: 1735689600000 },
                { id: 'g2', date: '2025-01-02', item: '黃金 XAUUSD', type: '空', rank: '銀單', entryPrice: '4014', units: '0.01', tp: '3970', sl: '4030', exitPrice: '3990', conditions: ['Vegas通道往下', 'RSI死亡交叉'], fundamental: false, news: false, reflection: '量會移動，做黃金要更新VP', timestamp: 1735776000000 },
                { id: 'g3', date: '2025-11-22', item: '黃金 XAUUSD', type: '空', rank: '銀單', entryPrice: '4069', units: '0.01', tp: '4030', sl: '4106', exitPrice: '4065', conditions: ['Vegas通道往下', 'RSI死亡交叉'], reflection: '15分空頭回調', timestamp: 1763769600000 },
                { id: 'g4', date: '2025-12-04', item: '黃金 XAUUSD', type: '多', rank: '銀單', entryPrice: '4191', units: '0.01', tp: '4212', sl: '4160', exitPrice: '4212', conditions: ['Vegas通道往上', 'RSI黃金交叉'], reflection: '碰到POC就跌，釐清原因', timestamp: 1764720000000 },
                { id: 'g5', date: '2025-12-05', item: '黃金 XAUUSD', type: '多', rank: '銅單', entryPrice: '4202', units: '0.01', tp: '4250', sl: '4190', exitPrice: '4250', conditions: ['Vegas通道往上', 'RSI黃金交叉'], reflection: '剛碰到VAH就往下砸', timestamp: 1764806400000 },
                { id: 'g6', date: '2025-12-09', item: '黃金 XAUUSD', type: '多', rank: '金單', entryPrice: '4183', units: '0.02', tp: '4250', sl: '4170', exitPrice: '4250', conditions: ['Vegas通道往上', 'RSI黃金交叉'], fundamental: true, news: true, reflection: '消息面或基本面調整預期', timestamp: 1765152000000 },
                { id: 'g7', date: '2025-12-11', item: '黃金 XAUUSD', type: '多', rank: '銅單', entryPrice: '4211', units: '0.02', tp: '4250', sl: '4170', exitPrice: '4250', conditions: ['Vegas通道往上', 'RSI黃金交叉'], news: true, reflection: '符合鮑爾降息消息面加倉', timestamp: 1765324800000 },
                { id: 'g8', date: '2025-12-12', item: '黃金 XAUUSD', type: '多', rank: '金單', entryPrice: '4239', units: '0.01', tp: '4193', sl: '4250', exitPrice: '4250', conditions: [], reflection: 'VAH高點M頭止損', timestamp: 1765411200000 },
                { id: 'g9', date: '2025-12-12', item: '黃金 XAUUSD', type: '空', rank: '銅單', entryPrice: '3994', units: '0.01', tp: '3919', sl: '4020', exitPrice: '4020', conditions: [], reflection: 'RSI過熱插針止損', timestamp: 1765411200001 },
                { id: 'g10', date: '2025-12-13', item: '黃金 XAUUSD', type: '空', rank: '銀單', entryPrice: '3994', units: '0.01', tp: '3045', sl: '4010', exitPrice: '4010', conditions: ['Vegas通道往下', 'RSI死亡交叉'], reflection: '等待均線下降訊號', timestamp: 1765497600000 },
                { id: 'g11', date: '2025-12-08', item: '黃金 XAUUSD', type: '多', rank: '銅單', entryPrice: '4209', units: '2', tp: '4250', sl: '4190', exitPrice: '4190', conditions: ['Vegas通道往上', 'RSI黃金交叉'], reflection: 'POC與VAL之間勝率高', timestamp: 1765065600000 },
                { id: 'g12', date: '2025-12-08', item: '黃金 XAUUSD', type: '多', rank: '銅單', entryPrice: '4210', units: '2', tp: '4250', sl: '4190', exitPrice: '4190', conditions: ['Vegas通道往上', 'RSI黃金交叉'], reflection: 'POC進單一單位就好', timestamp: 1765065600001 },
                { id: 'g13', date: '2025-12-10', item: '黃金 XAUUSD', type: '多', rank: '金單', entryPrice: '4197', units: '0.02', tp: '4212', sl: '4185', exitPrice: '4185', conditions: ['Vegas通道往上', 'RSI黃金交叉'], reflection: '降息不降息波動大，停損要後放', timestamp: 1765238400000 },
                { id: 'g14', date: '2025-12-31', item: '黃金 XAUUSD', type: '多', rank: '銀單', entryPrice: '4352', units: '0.02', tp: '4395', sl: '4320', exitPrice: '4320', conditions: ['Vegas通道往上', 'RSI黃金交叉'], reflection: '不能貪心，遵守到POC才做單', timestamp: 1767139200000 },
            ],
            generalInsights: ''
        };

        let tradingData = JSON.parse(localStorage.getItem(STORAGE_KEY));
        const isFirstLoad = !localStorage.getItem(STORAGE_KEY + '_initialized');

        if (isFirstLoad || !tradingData) {
            tradingData = initialData;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(tradingData));
            localStorage.setItem(STORAGE_KEY + '_initialized', 'true');
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(tradingData));
        }

        /**
         * 2. 核心邏輯
         */
        function determineResult(type, entry, exit) {
            const e = parseFloat(entry);
            const x = parseFloat(exit);
            if (isNaN(e) || isNaN(x)) return "待定";
            if (type === '多') return x > e ? "獲利" : (x < e ? "虧損" : "平手");
            else return x < e ? "獲利" : (x > e ? "虧損" : "平手");
        }

        function calculateTradeScore(record) {
            let score = 0;
            if (record.rank === '金單') score += 40;
            else if (record.rank === '銀單') score += 25;
            else if (record.rank === '銅單') score += 10;
            score += (record.conditions || []).length * 10;
            if (record.fundamental) score += 20;
            if (record.news) score += 20;
            return Math.min(score, 100);
        }

        function calculateRR(type, entry, tp, sl) {
            const e = parseFloat(entry);
            const t = parseFloat(tp);
            const s = parseFloat(sl);
            if (isNaN(e) || isNaN(t) || isNaN(s) || e === s) return "0.0";
            let rr = (type === '多') ? (t - e) / (e - s) : (e - t) / (s - e);
            return rr > 0 ? rr.toFixed(1) : "0.0";
        }

        function calculateFinalRR(type, entry, sl, exit) {
            const e = parseFloat(entry);
            const s = parseFloat(sl);
            const x = parseFloat(exit);
            if (isNaN(e) || isNaN(s) || isNaN(x) || e === s) return 0;
            return (type === '多') ? (x - e) / (e - s) : (e - x) / (s - e);
        }

        function calculateStockPnL(record) {
            const e = parseFloat(record.entryPrice);
            const x = parseFloat(record.exitPrice);
            if (isNaN(e) || isNaN(x)) return 0;
            const units = parseFloat(record.units || '1');
            const diff = (record.type === '多') ? (x - e) : (e - x);
            const totalFees = (e * units * 1000 * 0.001425) + (x * units * 1000 * 0.001425);
            return (diff * 1000 * units) - totalFees;
        }

        function calculateGoldPnL(record) {
            const e = parseFloat(record.entryPrice);
            const x = parseFloat(record.exitPrice);
            if (isNaN(e) || isNaN(x)) return 0;
            const units = parseFloat(record.units || '0.01');
            const diff = (record.type === '多') ? (x - e) : (e - x);
            const totalFees = 0.06 * 2 * (units / 0.01);
            return (diff * 100 * units) - totalFees;
        }

        function calculatePnL(record, marketType) {
            if (!record.exitPrice || record.exitPrice.toString().trim() === '') return 0;
            return (marketType === 'gold') ? calculateGoldPnL(record) : calculateStockPnL(record);
        }

        function getRankClass(rank) {
            if (rank === '金單') return 'rank-gold';
            if (rank === '銀單') return 'rank-silver';
            if (rank === '銅單') return 'rank-bronze';
            return 'bg-slate-800 text-slate-500 border-slate-700';
        }

        const stockMap = { 
            "2330": "台積電", "2317": "鴻海", "2454": "聯發科", "2303": "聯電", 
            "2603": "長榮", "2881": "富邦金", "3231": "緯創", "2382": "廣達",
            "7791": "皇家可口", "6217": "中探針", "3374": "精材", "2731": "雄獅",
            "2301": "光寶科", "2363": "矽統", "6517": "保勝光學", "1503": "士電",
            "6266": "凌華", "3036": "文曄", "2543": "皇昌", "6227": "茂綸",
            "3037": "欣興", "2464": "盟立", "6257": "矽格", "2727": "王品",
            "3706": "神達", "2354": "鴻準"
        };

        /**
         * 3. 渲染邏輯
         */
        window.currentFilter = '全部';

        window.navigateTo = (page, params = null) => {
            const container = document.getElementById('app-container');
            container.innerHTML = '';
            window.scrollTo(0, 0);

            switch(page) {
                case 'home': renderHome(container); break;
                case 'details': 
                    window.currentMarket = params;
                    renderDetails(container, params, window.currentFilter); 
                    break;
                case 'strategy': renderStrategy(container); break;
                case 'form': renderForm(container, params.type, params.id); break;
            }
        };

        function renderHome(container) {
            container.innerHTML = `
                <div class="page-transition">
                    <div class="mb-14 mt-4 text-center md:text-left">
                        <h2 class="text-5xl font-black text-white tracking-tighter">數據儀表板</h2>
                        <p class="text-xl text-slate-400 mt-4 font-medium italic">歷史紀錄備份已載入</p>
                    </div>

                    <div class="grid md:grid-cols-3 gap-8">
                        <div onclick="navigateTo('details', 'stock')" class="card-stock group p-12 rounded-[3rem] shadow-2xl cursor-pointer transform hover:-translate-y-3 transition-all duration-300 text-white relative border border-white/10">
                            <i class="fas fa-chart-line text-6xl mb-8 block"></i>
                            <h3 class="text-3xl font-black">台股市場紀錄</h3>
                            <p class="text-blue-100 opacity-80 mt-2 font-bold text-lg">Stock Records</p>
                        </div>
                        <div onclick="navigateTo('details', 'gold')" class="card-gold group p-12 rounded-[3rem] shadow-2xl cursor-pointer transform hover:-translate-y-3 transition-all duration-300 text-white relative border border-white/10">
                            <i class="fas fa-coins text-6xl mb-8 block"></i>
                            <h3 class="text-3xl font-black">黃金市場紀錄</h3>
                            <p class="text-amber-100 opacity-80 mt-2 font-bold text-lg">XAUUSD Records</p>
                        </div>
                        <div onclick="navigateTo('strategy')" class="card-strategy group p-12 rounded-[3rem] shadow-2xl cursor-pointer transform hover:-translate-y-3 transition-all duration-300 text-white relative border border-white/10">
                            <i class="fas fa-shield-halved text-6xl mb-8 block text-purple-200"></i>
                            <h3 class="text-3xl font-black">交易策略框架</h3>
                            <p class="text-purple-100 opacity-80 mt-2 font-bold text-lg">Core Strategy</p>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDetails(container, marketType, filter = '全部') {
            window.currentFilter = filter;
            const data = tradingData[marketType] || [];
            
            const settledAll = data.filter(d => d.exitPrice && d.exitPrice.toString().trim() !== "");
            const winsAll = settledAll.filter(d => determineResult(d.type, d.entryPrice, d.exitPrice) === '獲利').length;
            const winRate = settledAll.length > 0 ? ((winsAll / settledAll.length) * 100).toFixed(1) : '0.0';

            let totalR = 0;
            let totalPnL = 0;
            settledAll.forEach(d => {
                totalR += calculateFinalRR(d.type, d.entryPrice, d.sl, d.exitPrice);
                totalPnL += calculatePnL(d, marketType);
            });

            let filteredData = data;
            if (filter === '未結單') filteredData = data.filter(d => !d.exitPrice || d.exitPrice.toString().trim() === "");
            else if (filter === '獲利單') filteredData = data.filter(d => d.exitPrice && determineResult(d.type, d.entryPrice, d.exitPrice) === '獲利');
            else if (filter === '虧損單') filteredData = data.filter(d => d.exitPrice && determineResult(d.type, d.entryPrice, d.exitPrice) === '虧損');

            const pnlUnit = marketType === 'gold' ? 'USD' : 'TWD';

            container.innerHTML = `
                <div class="page-transition">
                    <div class="flex flex-col md:flex-row justify-between items-end mb-12 gap-6">
                        <div>
                            <button onclick="navigateTo('home')" class="text-slate-500 hover:text-blue-400 mb-4 flex items-center gap-3 text-lg font-black transition-all">
                                <i class="fas fa-chevron-left"></i> 返回首頁
                            </button>
                            <h2 class="text-4xl font-black text-white tracking-tight">${marketType === 'gold' ? '黃金 XAUUSD' : '台股市場'}</h2>
                        </div>
                        <button onclick="navigateTo('form', {type: '${marketType}'})" class="bg-blue-600 hover:bg-blue-500 text-white px-10 py-5 rounded-[2rem] flex items-center gap-3 shadow-2xl active:scale-95 font-black text-xl border border-blue-400/30">
                            <i class="fas fa-plus"></i> 新增紀錄
                        </button>
                    </div>

                    <div class="grid grid-cols-1 sm:grid-cols-4 gap-6 mb-8">
                        <div class="bg-slate-900 p-8 rounded-[3rem] border-2 border-slate-800 shadow-sm text-center">
                            <p class="text-sm font-black text-slate-500 mb-1 uppercase tracking-widest text-xs">勝率</p>
                            <span class="text-4xl font-black text-blue-500">${winRate}%</span>
                        </div>
                        <div class="bg-slate-900 p-8 rounded-[3rem] border-2 border-slate-800 shadow-sm text-center">
                            <p class="text-sm font-black text-slate-500 mb-1 uppercase tracking-widest text-xs">單數</p>
                            <span class="text-4xl font-black text-slate-200">${data.length}</span>
                        </div>
                        <div class="bg-slate-900 p-8 rounded-[3rem] border-2 border-slate-800 shadow-sm text-center">
                            <p class="text-sm font-black text-slate-500 mb-1 uppercase tracking-widest text-xs">總 R 數</p>
                            <span class="text-4xl font-black ${totalR >= 0 ? 'text-green-500' : 'text-red-400'}">${totalR.toFixed(1)} R</span>
                        </div>
                        <div class="bg-slate-900 p-8 rounded-[3rem] border-2 border-slate-800 shadow-sm text-center">
                            <p class="text-sm font-black text-slate-500 mb-1 uppercase tracking-widest text-xs">實際損益</p>
                            <span class="text-3xl font-black ${totalPnL >= 0 ? 'text-green-500' : 'text-red-400'}">${totalPnL.toFixed(2)}</span>
                        </div>
                    </div>

                    <div class="flex flex-row space-x-3 mb-10 overflow-x-auto pb-2 scrollbar-hide">
                        ${['全部', '未結單', '獲利單', '虧損單'].map(f => `
                            <button onclick="renderDetails(document.getElementById('app-container'), '${marketType}', '${f}')" 
                                    class="input-tab shrink-0 ${filter === f ? 'active' : 'inactive'}">
                                ${f}
                            </button>
                        `).join('')}
                    </div>

                    <div class="space-y-8">
                        ${filteredData.map(item => {
                            const result = determineResult(item.type, item.entryPrice, item.exitPrice);
                            const isSettled = item.exitPrice && item.exitPrice.toString().trim() !== "";
                            const finalR = calculateFinalRR(item.type, item.entryPrice, item.sl, item.exitPrice);
                            const pnl = calculatePnL(item, marketType);
                            return `
                            <div class="bg-slate-900 rounded-[3.5rem] border border-slate-800 shadow-sm overflow-hidden hover:border-slate-600 transition-all">
                                <div class="p-10 flex-1">
                                    <div class="flex justify-between items-start mb-8">
                                        <div>
                                            <div class="flex items-center gap-4 mb-3">
                                                <span class="text-sm font-bold text-slate-500">${item.date}</span>
                                                <span class="px-4 py-1 rounded-xl text-xs font-black border ${getRankClass(item.rank)}">${item.rank || '未分級'}</span>
                                                <span class="score-badge">Score: ${calculateTradeScore(item)}</span>
                                                <span class="text-xs font-black ${isSettled ? 'text-blue-400' : 'text-amber-500'}">
                                                    ${isSettled ? '已結單' : '持倉中'}
                                                </span>
                                            </div>
                                            <h3 class="text-3xl font-black text-white">
                                                ${item.item} 
                                                <span class="${item.type === '多' ? 'text-red-400' : 'text-green-400'}">[${item.type}]</span>
                                            </h3>
                                        </div>
                                        <div class="flex gap-4">
                                            <button onclick="navigateTo('form', {type: '${marketType}', id: '${item.id}'})" class="text-slate-600 hover:text-blue-400 transition-all p-4 text-2xl"><i class="fas fa-edit"></i></button>
                                            <button onclick="openDeleteModal('${marketType}', '${item.id}')" class="text-slate-600 hover:text-red-500 transition-all p-4 text-2xl"><i class="fas fa-trash-can"></i></button>
                                        </div>
                                    </div>
                                    
                                    <div class="grid grid-cols-2 md:grid-cols-5 gap-10 mb-10 text-center">
                                        <div><p class="text-slate-500 text-xs font-bold mb-1 uppercase tracking-widest">進場 / 單位</p><p class="font-mono font-black text-slate-200 text-2xl">${item.entryPrice} / ${item.units}</p></div>
                                        <div><p class="text-slate-500 text-xs font-bold mb-1 uppercase tracking-widest">出場價格</p><p class="font-mono font-black text-blue-400 text-2xl">${item.exitPrice || '-'}</p></div>
                                        <div><p class="text-slate-500 text-xs font-bold mb-1 uppercase tracking-widest">實際 R 數</p><p class="font-mono font-black text-purple-400 text-2xl">${isSettled ? finalR.toFixed(1) : '-'}</p></div>
                                        <div><p class="text-slate-500 text-xs font-bold mb-1 uppercase tracking-widest">判定結果</p><p class="font-black text-2xl ${result === '獲利' ? 'text-red-400' : (result === '虧損' ? 'text-green-400' : 'text-slate-400')}">${result}</p></div>
                                        <div><p class="text-slate-500 text-xs font-bold mb-1 uppercase tracking-widest">損益 (${pnlUnit})</p><p class="font-black text-2xl ${pnl >= 0 ? 'text-green-400' : 'text-red-400'}">${isSettled ? pnl.toFixed(2) : '-'}</p></div>
                                    </div>

                                    <div class="bg-slate-800/50 p-8 rounded-[2rem] text-lg text-slate-400 border border-slate-700/50">
                                        <strong class="text-slate-200 font-black">回測與反思：</strong> ${item.reflection || '無備註'}
                                    </div>
                                </div>
                            </div>
                        `;}).join('')}
                    </div>
                </div>
            `;
        }

        function renderForm(container, marketType, id = undefined) {
            const isEdit = typeof id === 'string' && id !== '';
            const isGold = marketType === 'gold';
            let record = isEdit ? tradingData[marketType].find(r => r.id === id) : null;
            
            if (!record) {
                record = {
                    id: Date.now().toString(), date: new Date().toISOString().split('T')[0],
                    item: isGold ? '黃金 XAUUSD' : '', type: '多', rank: '',
                    entryPrice: '', units: isGold ? '0.01' : '1',
                    tp: '', sl: '', exitPrice: '', conditions: [], fundamental: false, news: false, reflection: ''
                };
            }

            container.innerHTML = `
                <div class="page-transition max-w-7xl mx-auto mb-32">
                    <button onclick="navigateTo('details', '${marketType}')" class="text-slate-500 hover:text-blue-400 mb-10 flex items-center gap-3 font-black text-xl transition-all">
                        <i class="fas fa-chevron-left"></i> 取消並返回
                    </button>

                    <div class="bg-slate-900 rounded-[4rem] shadow-2xl border border-slate-800 overflow-hidden">
                        <div class="bg-slate-800/50 px-14 py-12 border-b border-slate-800 text-center">
                            <h2 class="text-4xl font-black text-white">${isEdit ? '編輯' : '新增'} ${isGold ? '黃金' : '台股'} 紀錄</h2>
                        </div>
                        
                        <form id="trading-form" class="p-14 space-y-14">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-10">
                                <div><label class="form-label">進場日期</label><input type="date" name="date" value="${record.date}" class="form-input" required></div>
                                <div class="md:col-span-1">
                                    <label class="form-label">交易標的</label>
                                    ${!isGold ? `
                                    <div class="flex flex-row space-x-2 mb-4">
                                        <div id="tab-auto" class="input-tab active" onclick="switchInputMethod('auto')">代號查找</div>
                                        <div id="tab-manual" class="input-tab inactive" onclick="switchInputMethod('manual')">手動輸入</div>
                                    </div>
                                    <div id="auto-lookup-box">
                                        <input type="text" placeholder="例如：2330" class="form-input" oninput="lookupStockId(this.value)">
                                        <p id="auto-lookup-result" class="mt-2 text-sm text-blue-400 font-bold">自動匹配名稱</p>
                                        <input type="hidden" id="item-hidden-input" name="item" value="${record.item}">
                                    </div>
                                    <div id="manual-input-box" class="hidden">
                                        <input type="text" class="form-input" placeholder="手動標的名稱" value="${record.item}" oninput="document.getElementById('item-hidden-input').value = this.value">
                                    </div>
                                    ` : `
                                    <input type="text" value="黃金 XAUUSD" class="form-input bg-slate-100 text-black font-bold" readonly>
                                    <input type="hidden" name="item" value="黃金 XAUUSD">
                                    `}
                                </div>
                                <div>
                                    <label class="form-label">交易方向</label>
                                    <select name="type" id="type-select" class="form-input font-black" onchange="updateFormUI(this.value, '${marketType}')">
                                        <option value="多" ${record.type === '多' ? 'selected' : ''}>多單 (Long)</option>
                                        <option value="空" ${record.type === '空' ? 'selected' : ''}>空單 (Short)</option>
                                    </select>
                                </div>
                            </div>

                            <section>
                                <h3 class="text-xl font-black text-blue-500 mb-8 border-b border-slate-800 pb-3 uppercase tracking-widest">核心評分與等級權重</h3>
                                <div class="grid md:grid-cols-2 gap-12">
                                    <div class="space-y-4" id="condition-section"></div>
                                    <div class="space-y-4" id="rank-section"></div>
                                </div>
                                
                                <h3 class="text-xl font-black text-blue-500 mb-8 mt-12 border-b border-slate-800 pb-3 uppercase tracking-widest">加分項目</h3>
                                <div class="grid md:grid-cols-2 gap-6">
                                    <label class="checkbox-card">
                                        <input type="checkbox" name="fundamental" ${record.fundamental ? 'checked' : ''} onchange="refreshCalculations()">
                                        <div class="flex flex-col">
                                            <span class="font-black text-slate-200 text-lg">基本面加分</span>
                                            <span class="text-xs text-slate-500 font-bold">營收與趨勢良好 +20 Pts</span>
                                        </div>
                                    </label>
                                    <label class="checkbox-card">
                                        <input type="checkbox" name="news" ${record.news ? 'checked' : ''} onchange="refreshCalculations()">
                                        <div class="flex flex-col">
                                            <span class="font-black text-slate-200 text-lg">消息面加分</span>
                                            <span class="text-xs text-slate-500 font-bold">重大新聞或籌碼支撐 +20 Pts</span>
                                        </div>
                                    </label>
                                </div>
                            </section>

                            <section>
                                <h3 class="text-xl font-black text-blue-500 mb-8 border-b border-slate-800 pb-3 uppercase tracking-widest">數據分析</h3>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-8">
                                    <div><label class="form-label">單位</label><input type="text" name="units" value="${record.units}" class="form-input"></div>
                                    <div><label class="form-label">進場價格</label><input type="text" id="entry-price" name="entryPrice" value="${record.entryPrice}" class="form-input" placeholder="價格" oninput="refreshCalculations()" required></div>
                                    <div><label class="form-label">停利 TP</label><input type="text" id="tp-price" name="tp" value="${record.tp}" class="form-input" placeholder="目標位" oninput="refreshCalculations()"></div>
                                    <div><label class="form-label">停損 SL</label><input type="text" id="sl-price" name="sl" value="${record.sl}" class="form-input" placeholder="防守位" oninput="refreshCalculations()"></div>
                                </div>
                                <div class="mt-10">
                                    <label class="form-label text-blue-400 text-xs uppercase tracking-widest font-black">出場價格 (有數值即自動判定結單)</label>
                                    <input type="text" id="exit-price" name="exitPrice" value="${record.exitPrice}" class="form-input border-blue-500/50" placeholder="填入出場價格" oninput="refreshCalculations()">
                                </div>
                                
                                <div class="mt-10 bg-slate-800 text-white p-10 rounded-[2.5rem] flex flex-col md:flex-row justify-between items-center shadow-inner border border-slate-700">
                                    <div class="flex gap-10">
                                        <div><span class="text-slate-500 font-bold block mb-1 uppercase text-xs">預計盈虧比</span><span id="rr-preview" class="text-3xl font-black text-purple-400">0.0 R</span></div>
                                        <div><span class="text-slate-500 font-bold block mb-1 uppercase text-xs">判定結果</span><span id="result-preview" class="text-3xl font-black text-white">-</span></div>
                                    </div>
                                    <div class="text-center md:text-right">
                                        <span class="text-slate-500 font-bold block mb-1 uppercase text-xs">綜合得分</span>
                                        <span id="score-preview" class="text-5xl font-black text-green-400">0 Pts</span>
                                    </div>
                                </div>
                            </section>

                            <section class="w-full">
                                <label class="form-label">複盤與檢討紀錄</label>
                                <textarea name="reflection" rows="14" class="form-input block w-full" style="width: 100% !important; min-width: 100% !important;" placeholder="記錄您的心理狀態、紀律執行或技術細節...">${record.reflection}</textarea>
                            </section>

                            <div class="pt-10">
                                <button type="button" onclick="handleSave('${marketType}', '${isEdit ? record.id : ''}')" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-8 rounded-[2rem] shadow-2xl transition-all active:scale-[0.98] text-2xl uppercase border border-blue-400/30 tracking-widest">
                                    同步儲存交易紀錄
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            updateFormUI(record.type, marketType, record.conditions, record.rank);
            refreshCalculations();
        }

        window.updateFormUI = (tradeType, marketType, savedConds = [], savedRank = '') => {
            const condEl = document.getElementById('condition-section');
            const rankEl = document.getElementById('rank-section');
            let conds = (tradeType === '多') ? ['Vegas通道往上', 'RSI黃金交叉'] : ['Vegas通道往下', 'RSI死亡交叉'];
            let ranks = (tradeType === '多') ? 
                [{n:'金單',d:'VAL插針'}, {n:'銀單',d:'VAL/POC區間'}, {n:'銅單',d:'POC處'}] : 
                [{n:'金單',d:'VAH插針'}, {n:'銀單',d:'VAL/POC區間'}, {n:'銅單',d:'POC處'}];
            
            condEl.innerHTML = conds.map(c => `<label class="checkbox-card"><input type="checkbox" name="conditions" value="${c}" ${savedConds.includes(c)?'checked':''} onchange="refreshCalculations()"> <span class="text-base font-black text-slate-200">${c}</span></label>`).join('');
            rankEl.innerHTML = ranks.map(r => `
                <label class="checkbox-card ${savedRank === r.n ? 'ring-4 ring-blue-500 bg-slate-700' : ''} ${r.n === '金單' ? 'border-yellow-600/30' : (r.n === '銀單' ? 'border-slate-500/30' : 'border-orange-600/30')}">
                    <input type="radio" name="rank" value="${r.n}" ${savedRank === r.n ? 'checked' : ''} onchange="refreshCalculations()"> 
                    <div class="flex-1 flex justify-between items-center">
                        <div class="flex flex-col">
                            <span class="font-black text-slate-200 text-lg">${r.n}</span>
                            <span class="text-xs text-slate-500 font-bold">${r.d}</span>
                        </div>
                    </div>
                </label>
            `).join('');
        };

        window.refreshCalculations = () => {
            const entry = document.getElementById('entry-price').value;
            const exit = document.getElementById('exit-price').value;
            const type = document.getElementById('type-select').value;
            const tp = document.getElementById('tp-price').value;
            const sl = document.getElementById('sl-price').value;

            const res = determineResult(type, entry, exit);
            const resEl = document.getElementById('result-preview');
            resEl.innerText = res;
            resEl.className = `text-3xl font-black ${res === '獲利' ? 'text-red-400' : (res === '虧損' ? 'text-green-400' : 'text-slate-300')}`;

            document.getElementById('rr-preview').innerText = calculateRR(type, entry, tp, sl) + " R";

            const rank = document.querySelector('input[name="rank"]:checked')?.value;
            const conds = Array.from(document.querySelectorAll('input[name="conditions"]:checked')).map(e => e.value);
            const fundamental = document.querySelector('input[name="fundamental"]')?.checked || false;
            const news = document.querySelector('input[name="news"]')?.checked || false;
            const score = calculateTradeScore({ rank, conditions: conds, fundamental, news });
            document.getElementById('score-preview').innerText = score + " Pts";
        };

        let deleteTarget = { market: null, id: null };
        window.openDeleteModal = (market, id) => {
            deleteTarget = { market, id };
            document.getElementById('delete-modal').style.display = 'flex';
        };
        window.closeDeleteModal = () => document.getElementById('delete-modal').style.display = 'none';

        document.getElementById('confirm-delete-btn').onclick = () => {
            const { market, id } = deleteTarget;
            tradingData[market] = tradingData[market].filter(r => r.id !== id);
            saveData();
            closeDeleteModal();
            navigateTo('details', market);
        };

        window.handleSave = (market, idStr) => {
            const form = document.getElementById('trading-form');
            const formData = new FormData(form);
            const finalId = (idStr && idStr !== '') ? idStr : Date.now().toString();
            
            const record = {
                id: finalId,
                date: formData.get('date'),
                item: formData.get('item'),
                type: formData.get('type'),
                rank: formData.get('rank') || '',
                entryPrice: formData.get('entryPrice'),
                units: formData.get('units'),
                tp: formData.get('tp'),
                sl: formData.get('sl'),
                exitPrice: formData.get('exitPrice'),
                conditions: Array.from(document.querySelectorAll('input[name="conditions"]:checked')).map(e => e.value),
                fundamental: document.querySelector('input[name="fundamental"]')?.checked || false,
                news: document.querySelector('input[name="news"]')?.checked || false,
                reflection: formData.get('reflection'),
                timestamp: Date.now()
            };
            
            const index = tradingData[market].findIndex(r => r.id === finalId);
            if (index > -1) tradingData[market][index] = record;
            else tradingData[market].unshift(record);
            
            saveData();
            navigateTo('details', market);
        };

        function renderStrategy(container) {
            container.innerHTML = `
                <div class="page-transition">
                    <button onclick="navigateTo('home')" class="text-slate-500 hover:text-blue-400 mb-10 flex items-center gap-3 font-black text-xl transition-all">
                        <i class="fas fa-chevron-left"></i> 返回主頁
                    </button>
                    <div class="flex items-center gap-6 mb-16">
                        <div class="bg-blue-600 text-white p-6 rounded-[2.5rem] shadow-2xl"><i class="fas fa-scroll text-4xl"></i></div>
                        <div><h2 class="text-4xl font-black text-white">核心交易策略框架</h2><p class="text-xl text-slate-500 font-bold">四大支柱：從趨勢到技術執行</p></div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-12">
                        <div class="bg-slate-900 p-10 rounded-[3rem] border border-slate-800 shadow-sm"><h3 class="text-2xl font-black text-blue-500 mb-6">1. 趨勢確認 (Trend)</h3><p class="text-slate-400 text-lg">依據大時區 Vegas 通道。價格在通道之上且通道向上為多頭；反之為空頭。</p></div>
                        <div class="bg-slate-900 p-10 rounded-[3rem] border border-slate-800 shadow-sm"><h3 class="text-2xl font-black text-blue-500 mb-6">2. 基本面加分 (Fundamental)</h3><p class="text-slate-400 text-lg">觀察營收與消息面。良好的基本面決定了持倉信心。</p></div>
                        <div class="bg-slate-900 p-10 rounded-[3rem] border border-slate-800 shadow-sm"><h3 class="text-2xl font-black text-blue-500 mb-6">3. 消息面加分 (News)</h3><p class="text-slate-400 text-lg text-sm">關注地緣政治或法人籌碼，消息面常是脫離成本區的觸媒。</p></div>
                        <div class="bg-slate-900 p-10 rounded-[3rem] border border-slate-800 shadow-sm"><h3 class="text-2xl font-black text-blue-500 mb-6">4. 技術執行 (Technical)</h3><p class="text-slate-400 text-lg">依據 VP 等級判斷入場，結合 RSI 交叉扣板機。嚴格執行 TP/SL。</p></div>
                    </div>

                    <!-- 新增：總體交易心得區塊 -->
                    <div class="bg-slate-900 p-10 rounded-[3rem] border border-slate-800 shadow-xl mt-10">
                        <h3 class="text-2xl font-black text-blue-500 mb-6 flex items-center gap-3">
                            <i class="fas fa-brain"></i> 總體交易心得與觀察
                        </h3>
                        <textarea id="general-insights-input" class="form-input" rows="15" placeholder="記錄您的市場觀察、心法修煉、或是對近期策略執行率的檢討...">${tradingData.generalInsights || ''}</textarea>
                        <div class="mt-8">
                            <button onclick="saveGeneralInsights()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-6 rounded-2xl shadow-2xl transition-all active:scale-95 text-xl tracking-widest">
                                <i class="fas fa-save mr-2"></i> 儲存總體心得
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // 新增：儲存總體心得函數
        window.saveGeneralInsights = () => {
            const input = document.getElementById('general-insights-input');
            if (input) {
                tradingData.generalInsights = input.value;
                saveData();
                const btn = event.currentTarget;
                const originalContent = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check mr-2"></i> 心得已儲存';
                btn.classList.replace('bg-blue-600', 'bg-green-600');
                setTimeout(() => {
                    btn.innerHTML = originalContent;
                    btn.classList.replace('bg-green-600', 'bg-blue-600');
                }, 2000);
            }
        };

        window.switchInputMethod = (method) => {
            const autoBox = document.getElementById('auto-lookup-box');
            const manualBox = document.getElementById('manual-input-box');
            const autoTab = document.getElementById('tab-auto');
            const manualTab = document.getElementById('tab-manual');
            if (method === 'auto') {
                autoBox.classList.remove('hidden'); manualBox.classList.add('hidden');
                autoTab.classList.add('active'); autoTab.classList.remove('inactive');
                manualTab.classList.remove('active'); manualTab.classList.add('inactive');
            } else {
                autoBox.classList.add('hidden'); manualBox.classList.remove('hidden');
                autoTab.classList.remove('active'); autoTab.classList.add('inactive');
                manualTab.classList.add('active'); manualTab.classList.remove('inactive');
            }
        };

        window.lookupStockId = (id) => {
            const display = document.getElementById('auto-lookup-result');
            const hiddenInput = document.getElementById('item-hidden-input');
            if (stockMap[id]) {
                display.innerText = `找到標的：${stockMap[id]}`;
                display.className = "mt-2 text-sm text-blue-400 font-black";
                hiddenInput.value = `${stockMap[id]} ${id}`;
            } else {
                display.innerText = id.length >= 4 ? "查無代號，請使用手動輸入" : "請輸入 4 碼代號";
                display.className = "mt-2 text-sm text-slate-500 font-bold";
                hiddenInput.value = "";
            }
        };

        window.onload = () => navigateTo('home');
    </script>
</body>
</html>
