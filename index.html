<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>個人交易追蹤系統</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700;900&display=swap');
        
        :root {
            font-size: 18px;
            --bs-primary: #2563eb;
            --bs-danger: #dc3545;
            --bs-success: #198754;
            --bs-warning: #ffc107;
            --bs-info: #0dcaf0;
            --bs-dark: #212529;
            --bs-light: #f8f9fa;
            --color-gold: #fbbf24;
            --color-silver: #cbd5e1;
            --color-bronze: #b45309;
        }
        
        body {
            font-family: 'Noto Sans TC', sans-serif;
            line-height: 1.6;
            background-color: #020617;
            color: #f1f5f9;
            padding-bottom: 3rem;
        }

        .card-stock { 
            background: linear-gradient(135deg, #1e3a8a 0%, #2563eb 100%);
            border: 1px solid rgba(255,255,255,0.1) !important;
        }
        .card-gold { 
            background: linear-gradient(135deg, #78350f 0%, #b45309 100%);
            border: 1px solid rgba(255,255,255,0.1) !important;
        }
        .card-strategy { 
            background: linear-gradient(135deg, #4c1d95 0%, #7c3aed 100%);
            border: 1px solid rgba(255,255,255,0.1) !important;
        }
        
        .glass-effect {
            background: rgba(15, 23, 42, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 2px solid rgba(51, 65, 85, 0.5);
        }

        .form-control {
            background-color: #ffffff;
            color: #000000;
            border: 2px solid #cbd5e1;
            border-radius: 1.5rem;
            padding: 1.5rem 1.5rem;
            font-size: 1rem;
            min-height: 56px;
            font-weight: 500;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
        }

        .form-control::placeholder {
            color: #94a3b8;
        }

        .form-control:focus {
            background-color: #ffffff;
            color: #000000;
            border-color: #2563eb;
            box-shadow: 0 0 0 0.2rem rgba(37, 99, 235, 0.25);
            outline: none;
        }

        .form-control.select-control {
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23334155'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'%3E%3C/path%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1.2em;
            padding-right: 3rem;
        }

        .form-label {
            display: block;
            font-size: 1rem;
            font-weight: 900;
            color: #cbd5e1;
            margin-bottom: 0.75rem;
        }

        .rank-gold {
            background: var(--color-gold);
            color: black;
            border: 1px solid #fcd34d;
            box-shadow: 0 0 15px rgba(250, 204, 21, 0.4);
            border-radius: 0.5rem;
            font-weight: 900;
            padding: 0.375rem 1rem;
            display: inline-block;
        }

        .rank-silver {
            background: var(--color-silver);
            color: black;
            border: 1px solid #f1f5f9;
            box-shadow: 0 0 15px rgba(203, 213, 225, 0.3);
            border-radius: 0.5rem;
            font-weight: 900;
            padding: 0.375rem 1rem;
            display: inline-block;
        }

        .rank-bronze {
            background: var(--color-bronze);
            color: white;
            border: 1px solid #f97316;
            box-shadow: 0 0 15px rgba(234, 88, 12, 0.3);
            border-radius: 0.5rem;
            font-weight: 900;
            padding: 0.375rem 1rem;
            display: inline-block;
        }

        .rank-none {
            background: #020617;
            color: #f9fafb;
            border: 1px solid #ffffff;
            box-shadow: 0 0 15px rgba(15, 23, 42, 0.5);
            border-radius: 0.5rem;
            font-weight: 900;
            padding: 0.375rem 1rem;
            display: inline-block;
        }

        .score-badge {
            padding: 0.375rem 1rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 900;
            background: #2563eb;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            display: inline-block;
        }

        .input-tab {
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            font-weight: 900;
            border: 2px solid transparent;
            cursor: pointer;
            user-select: none;
        }

        .input-tab.active {
            background: white;
            border: 2px solid white;
            color: black;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .input-tab.inactive {
            background: #1e293b;
            border: 2px solid #1e293b;
            color: #64748b;
        }

        #delete-modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.85);
            backdrop-filter: blur(10px);
            align-items: center;
            justify-content: center;
        }

        .nav-navbar {
            position: sticky;
            top: 0;
            z-index: 50;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .checkbox-input {
            width: 1.5rem;
            height: 1.5rem;
            accent-color: #2563eb;
            border: 1px solid #64748b;
            cursor: pointer;
        }

        .card-hover {
            transform: translateY(0);
            transition: transform 0.3s ease;
            cursor: pointer;
        }

        .card-hover:hover {
            transform: translateY(-0.75rem);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .page-transition {
            /* 移除動畫 */
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .textarea-large {
            min-height: 420px;
            font-family: 'Noto Sans TC', sans-serif;
        }

        .stat-box {
            background: #1e293b;
            border: 2px solid #334155;
            border-radius: 2.5rem;
            padding: 2rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .stat-label {
            font-size: 0.75rem;
            font-weight: 900;
            color: #64748b;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 900;
            color: #e2e8f0;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
        }

        .rounded-3xl {
            border-radius: 2rem;
        }

        .rounded-4xl {
            border-radius: 3rem;
        }

        .btn-primary-custom {
            background: #2563eb;
            border: none;
            color: white;
            font-weight: 900;
            padding: 1.25rem 2.5rem;
            border-radius: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(59, 130, 246, 0.3);
        }

        .btn-primary-custom:hover {
            background: #1d4ed8;
        }

        .btn-primary-custom:active {
            transform: scale(0.98);
        }

        .btn-danger-custom {
            background: #dc2626;
            border: none;
            color: white;
            font-weight: 900;
            padding: 1.25rem 2.5rem;
            border-radius: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(220, 38, 38, 0.2);
        }

        .btn-danger-custom:hover {
            background: #b91c1c;
        }

        .container-max {
            max-width: 1280px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .w-full {
            width: 100%;
        }

        .mb-14 {
            margin-bottom: 3.5rem;
        }

        .mt-4 {
            margin-top: 1rem;
        }

        .flex-center {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gap-4 {
            gap: 1rem;
        }

        .gap-6 {
            gap: 1.5rem;
        }

        .gap-8 {
            gap: 2rem;
        }
    </style>
</head>
<body>

    <!-- 刪除確認視窗 -->
    <div id="delete-modal">
        <div class="bg-dark border-2 p-5 rounded-4xl" style="max-width: 25rem; width: 100%; margin: 0 1rem;">
            <div class="text-danger mb-5 text-center" style="font-size: 3rem;">
                <i class="fas fa-exclamation-triangle"></i>
            </div>
            <h3 class="h4 fw-black text-white text-center mb-3">確定永久刪除？</h3>
            <p class="text-secondary text-center mb-5">此操作無法復原，該筆交易紀錄將從本地儲存空間移除。</p>
            <div class="d-flex gap-3">
                <button onclick="closeDeleteModal()" class="btn btn-secondary flex-grow-1 fw-bold py-3">取消</button>
                <button id="confirm-delete-btn" class="btn btn-danger flex-grow-1 fw-bold py-3">確定刪除</button>
            </div>
        </div>
    </div>

    <!-- 導覽列 -->
    <nav class="glass-effect nav-navbar">
        <div class="container-max">
            <div class="d-flex justify-content-between align-items-center py-3">
                <div class="d-flex align-items-center gap-3 cursor-pointer" onclick="navigateTo('home')" style="cursor: pointer;">
                    <div class="bg-primary p-2 rounded-3xl text-white" style="box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);">
                        <i class="fas fa-chart-line" style="font-size: 1.5rem;"></i>
                    </div>
                    <h1 class="h3 fw-black text-white mb-0">個人交易追蹤系統</h1>
                </div>
                
                <div class="d-flex align-items-center gap-2 bg-dark px-3 py-2 rounded-3xl border" style="border-color: #475569;">
                    <i class="fas fa-database" style="font-size: 0.875rem; color: #2563eb;"></i>
                    <span class="small fw-bold text-secondary">本地儲存模式</span>
                </div>
            </div>
        </div>
    </nav>

    <main id="app-container" class="container-max">
    </main>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        /** 1. 資料管理 **/
        const STORAGE_KEY = 'vp_trading_tracker_v5_local_final';
        
        const initialData = {
            stock: [],
            gold: [],
            generalInsights: ''
        };

        let tradingData = JSON.parse(localStorage.getItem(STORAGE_KEY));
        const initMarker = localStorage.getItem(STORAGE_KEY + '_initialized');

        if (!tradingData || !initMarker || (tradingData.stock.length === 0 && tradingData.gold.length === 0)) {
            tradingData = initialData;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(tradingData));
            localStorage.setItem(STORAGE_KEY + '_initialized', 'true');
        }

        function saveData() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(tradingData));
        }

        window.exportTradingData = () => {
            const dataStr = JSON.stringify(tradingData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const now = new Date();
            const ts = now.toISOString().slice(0,19).replace(/[:T]/g, '-');
            a.href = url;
            a.download = `trading_backup_${ts}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        window.importTradingData = (file) => {
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const obj = JSON.parse(e.target.result);
                    if (!obj || !Array.isArray(obj.stock) || !Array.isArray(obj.gold)) {
                        alert('匯入失敗：檔案格式不正確（缺少 stock/gold 陣列）。');
                        return;
                    }
                    tradingData = {
                        stock: obj.stock,
                        gold: obj.gold,
                        generalInsights: obj.generalInsights || ''
                    };
                    saveData();
                    alert('匯入完成，已套用新的交易紀錄。');
                    navigateTo('home');
                } catch (err) {
                    console.error(err);
                    alert('匯入失敗：檔案內容不是合法的 JSON。');
                }
            };
            reader.readAsText(file, 'utf-8');
        };

        /** 2. 核心邏輯 **/
        function determineResult(type, entry, exit) {
            const e = parseFloat(entry);
            const x = parseFloat(exit);
            if (isNaN(e) || isNaN(x)) return "待定";
            if (type === '多') return x > e ? "獲利" : (x < e ? "虧損" : "平手");
            else return x < e ? "獲利" : (x > e ? "虧損" : "平手");
        }

        function calculateTradeScore(record) {
            let score = 0;
            if (record.rank === '金單') score += 40;
            else if (record.rank === '銀單') score += 25;
            else if (record.rank === '銅單') score += 10;
            score += (record.conditions || []).length * 10;
            if (record.fundamental) score += 20;
            if (record.news) score += 20;
            return Math.min(score, 100);
        }

        function calculateRR(type, entry, tp, sl) {
            const e = parseFloat(entry);
            const t = parseFloat(tp);
            const s = parseFloat(sl);
            if (isNaN(e) || isNaN(t) || isNaN(s) || e === s) return "0.0";
            let rr = (type === '多') ? (t - e) / (e - s) : (e - t) / (s - e);
            return rr > 0 ? rr.toFixed(1) : "0.0";
        }

        function calculateFinalRR(type, entry, sl, exit) {
            const e = parseFloat(entry);
            const s = parseFloat(sl);
            const x = parseFloat(exit);
            if (isNaN(e) || isNaN(s) || isNaN(x) || e === s) return 0;
            return (type === '多') ? (x - e) / (e - s) : (e - x) / (s - e);
        }

        function calculatePnL(record, marketType) {
            const e = parseFloat(record.entryPrice);
            const x = parseFloat(record.exitPrice);
            if (isNaN(e) || isNaN(x)) return 0;
            if (marketType === 'gold') {
                const units = parseFloat(record.units || '0.01');
                const diff = (record.type === '多') ? (x - e) : (e - x);
                return (diff * 100 * units) - (0.06 * 2 * (units / 0.01));
            } else {
                const units = parseFloat(record.units || '1');
                const diff = (record.type === '多') ? (x - e) : (e - x);
                const totalFees = (e * units * 1000 * 0.001425) + (x * units * 1000 * 0.001425);
                return (diff * 1000 * units) - totalFees;
            }
        }

        function getRankClass(rank) {
            if (rank === '金單') return 'rank-gold';
            if (rank === '銀單') return 'rank-silver';
            if (rank === '銅單') return 'rank-bronze';
            if (rank === '無') return 'rank-none';
            return 'bg-dark text-secondary border';
        }

        const stockMap = { "2330": "台積電", "2317": "鴻海", "2454": "聯發科", "2303": "聯電", "2603": "長榮", "2881": "富邦金", "3231": "緯創", "2382": "廣達", "7791": "皇家可口", "6217": "中探針", "3374": "精材", "2731": "雄獅", "2301": "光寶科", "2363": "矽統", "6517": "保勝光學", "1503": "士電", "6266": "凌華", "3036": "文曄", "2543": "皇昌", "6227": "茂綸", "3037": "欣興", "2464": "盟立", "6257": "矽格", "2727": "王品", "3706": "神達", "2354": "鴻準" };

        /** 3. 渲染與路由 **/
        window.currentFilter = '全部';
        window.navigateTo = (page, params = null) => {
            const container = document.getElementById('app-container');
            container.innerHTML = '';
            container.style.opacity = '1';
            switch(page) {
                case 'home': renderHome(container); break;
                case 'details': window.currentMarket = params; renderDetails(container, params, window.currentFilter); break;
                case 'strategy': renderStrategy(container); break;
                case 'form': renderForm(container, params.type, params.id); break;
            }
            window.scrollTo(0, 0);
        };

        function renderHome(container) {
            container.innerHTML = `
                <div class="page-transition">
                    <div class="mb-14 mt-4">
                        <h2 class="h2 fw-black text-white">數據儀表板</h2>
                        <p class="fs-5 text-secondary mt-3 fw-bold" style="font-style: italic;">掌握趨勢，精準執行</p>
                    </div>
                    <div class="row mb-5">
                        <div class="col-md-4 mb-3">
                            <div class="card card-stock card-hover rounded-4xl p-5 text-white h-100" onclick="navigateTo('details', 'stock')" style="cursor: pointer;">
                                <i class="fas fa-chart-line mb-4" style="font-size: 3.75rem;"></i>
                                <h3 class="h4 fw-black">台股市場紀錄</h3>
                                <p class="mb-0 fw-bold" style="opacity: 0.8;">Stock Records</p>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card card-gold card-hover rounded-4xl p-5 text-white h-100" onclick="navigateTo('details', 'gold')" style="cursor: pointer;">
                                <i class="fas fa-coins mb-4" style="font-size: 3.75rem;"></i>
                                <h3 class="h4 fw-black">黃金市場紀錄</h3>
                                <p class="mb-0 fw-bold" style="opacity: 0.8;">XAUUSD Records</p>
                            </div>
                        </div>
                        <div class="col-md-4 mb-3">
                            <div class="card card-strategy card-hover rounded-4xl p-5 text-white h-100" onclick="navigateTo('strategy')" style="cursor: pointer;">
                                <i class="fas fa-shield-halved mb-4" style="font-size: 3.75rem; color: #e9d5ff;"></i>
                                <h3 class="h4 fw-black">交易策略框架</h3>
                                <p class="mb-0 fw-bold" style="opacity: 0.8;">Core Strategy</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-dark border rounded-4xl p-4 d-flex flex-column flex-md-row justify-content-between gap-3 align-items-center">
                        <div class="flex-grow-1 text-secondary small">
                            <div class="fw-black text-light mb-1">交易紀錄備份與還原</div>
                            <div>匯出目前所有台股 / 黃金 / 心得紀錄為 JSON 檔，日後可在其他瀏覽器匯入還原。</div>
                        </div>
                        <div class="d-flex gap-2">
                            <button type="button" onclick="exportTradingData()" class="btn btn-success fw-bold">
                                <i class="fas fa-download me-2"></i>匯出備份
                            </button>
                            <label class="btn btn-dark fw-bold border" style="cursor: pointer;">
                                <i class="fas fa-upload me-2"></i>匯入備份
                                <input type="file" accept=".json,application/json" class="d-none" onchange="importTradingData(this.files[0]); this.value='';">
                            </label>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderDetails(container, marketType, filter = '全部') {
            window.currentFilter = filter;
            const data = tradingData[marketType] || [];
            const settledAll = data.filter(d => d.exitPrice && d.exitPrice.toString().trim() !== "");
            const winsAll = settledAll.filter(d => determineResult(d.type, d.entryPrice, d.exitPrice) === '獲利').length;
            const winRate = settledAll.length > 0 ? ((winsAll / settledAll.length) * 100).toFixed(1) : '0.0';

            let totalR = 0, totalPnL = 0;
            settledAll.forEach(d => {
                totalR += calculateFinalRR(d.type, d.entryPrice, d.sl, d.exitPrice);
                totalPnL += calculatePnL(d, marketType);
            });

            let filteredData = data;
            if (filter === '未結單') filteredData = data.filter(d => !d.exitPrice || d.exitPrice.toString().trim() === "");
            else if (filter === '獲利單') filteredData = data.filter(d => d.exitPrice && determineResult(d.type, d.entryPrice, d.exitPrice) === '獲利');
            else if (filter === '虧損單') filteredData = data.filter(d => d.exitPrice && determineResult(d.type, d.entryPrice, d.exitPrice) === '虧損');

            const pnlUnit = marketType === 'gold' ? 'USD' : 'TWD';

            container.innerHTML = `
                <div class="page-transition">
                    <div class="d-flex flex-column flex-md-row justify-content-between align-items-end mb-5 gap-4">
                        <div>
                            <button onclick="navigateTo('home')" class="btn btn-link text-secondary mb-3 p-0 fw-black">
                                <i class="fas fa-chevron-left me-2"></i> 返回首頁
                            </button>
                            <h2 class="h3 fw-black text-white">${marketType === 'gold' ? '黃金 XAUUSD' : '台股市場'}</h2>
                        </div>
                        <button onclick="navigateTo('form', {type: '${marketType}'})" class="btn-primary-custom d-flex align-items-center gap-2">
                            <i class="fas fa-plus"></i> 新增紀錄
                        </button>
                    </div>

                    <div class="row mb-4">
                        <div class="col-sm-6 col-md-3 mb-3">
                            <div class="stat-box">
                                <div class="stat-label">目前勝率統計</div>
                                <div class="stat-value text-primary">${winRate}%</div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-md-3 mb-3">
                            <div class="stat-box">
                                <div class="stat-label">總計單數累計</div>
                                <div class="stat-value">${data.length}</div>
                            </div>
                        </div>
                        <div class="col-sm-6 col-md-3 mb-3">
                            <div class="stat-box">
                                <div class="stat-label">總 R 數</div>
                                <div class="stat-value ${totalR >= 0 ? 'text-success' : 'text-danger'}">${totalR.toFixed(1)} R</div>
                                <p class="text-secondary small mt-2 mb-0">累積實際 R（已結單）</p>
                            </div>
                        </div>
                        <div class="col-sm-6 col-md-3 mb-3">
                            <div class="stat-box">
                                <div class="stat-label">實際盈虧</div>
                                <div class="stat-value ${totalPnL >= 0 ? 'text-success' : 'text-danger'}">${totalPnL.toFixed(2)} ${pnlUnit}</div>
                                <p class="text-secondary small mt-2 mb-0">依單位與價差換算</p>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2 mb-4 scrollbar-hide" style="overflow-x: auto; padding-bottom: 0.5rem;">
                        ${['全部', '未結單', '獲利單', '虧損單'].map(f => `
                            <button onclick="renderDetails(document.getElementById('app-container'), '${marketType}', '${f}')"
                                    class="input-tab ${filter === f ? 'active' : 'inactive'}" style="white-space: nowrap;">
                                ${f}
                            </button>
                        `).join('')}
                    </div>

                    <div class="space-y-4">
                        ${filteredData.map(item => {
                            const result = determineResult(item.type, item.entryPrice, item.exitPrice);
                            const isSettled = item.exitPrice && item.exitPrice.toString().trim() !== "";
                            const finalR = calculateFinalRR(item.type, item.entryPrice, item.sl, item.exitPrice);
                            const pnl = calculatePnL(item, marketType);
                            return `
                            <div class="bg-dark border rounded-4xl p-5 mb-3 overflow-hidden" style="border-color: #334155;">
                                <div class="d-flex justify-content-between align-items-start mb-4">
                                    <div>
                                        <div class="d-flex align-items-center gap-3 mb-2 flex-wrap">
                                            <span class="small text-secondary">${item.date}</span>
                                            <span class="px-2 py-1 rounded small fw-bold ${getRankClass(item.rank)}">${item.rank || '未分級'}</span>
                                            <span class="score-badge">Score: ${calculateTradeScore(item)}</span>
                                            <span class="small fw-black ${isSettled ? 'text-info' : 'text-warning'}">
                                                ${isSettled ? '已結單' : '持倉中'}
                                            </span>
                                        </div>
                                        <h3 class="h5 fw-black text-white mb-0">${item.item} <span class="${item.type === '多' ? 'text-danger' : 'text-success'}">[${item.type}]</span></h3>
                                    </div>
                                    <div class="d-flex gap-2">
                                        <button onclick="navigateTo('form', {type: '${marketType}', id: '${item.id}'})" class="btn btn-link text-secondary p-2"><i class="fas fa-edit"></i></button>
                                        <button onclick="openDeleteModal('${marketType}', '${item.id}')" class="btn btn-link text-danger p-2"><i class="fas fa-trash-can"></i></button>
                                    </div>
                                </div>
                                <div class="row gap-4 mb-3">
                                    <div class="col text-center">
                                        <p class="small text-secondary fw-bold mb-1 text-uppercase">進場 / 單位</p>
                                        <p class="font-monospace fw-black text-light">${item.entryPrice} / ${item.units} ${marketType === 'gold' ? '手' : '張'}</p>
                                    </div>
                                    <div class="col text-center">
                                        <p class="small text-secondary fw-bold mb-1 text-uppercase">出場價格</p>
                                        <p class="font-monospace fw-black text-info">${item.exitPrice || '-'}</p>
                                    </div>
                                    <div class="col text-center">
                                        <p class="small text-secondary fw-bold mb-1 text-uppercase">實際 R 數</p>
                                        <p class="font-monospace fw-black text-primary">${isSettled ? finalR.toFixed(1) : '-'}</p>
                                    </div>
                                    <div class="col text-center">
                                        <p class="small text-secondary fw-bold mb-1 text-uppercase">判定結果</p>
                                        <p class="fw-black ${result === '獲利' ? 'text-danger' : (result === '虧損' ? 'text-success' : 'text-secondary')}">${result}</p>
                                    </div>
                                    <div class="col text-center">
                                        <p class="small text-secondary fw-bold mb-1 text-uppercase">實際損益</p>
                                        <p class="fw-black ${pnl >= 0 ? 'text-success' : 'text-danger'}">${isSettled ? pnl.toFixed(2) + ' ' + pnlUnit : '-'}</p>
                                    </div>
                                </div>
                                <div class="d-flex flex-wrap gap-2 mb-3">
                                    ${(item.conditions || []).map(c => `<span class="badge bg-primary opacity-75">${c}</span>`).join('')}
                                    ${item.fundamental ? `<span class="badge bg-success">基本面加分</span>` : ''}
                                    ${item.news ? `<span class="badge bg-warning text-dark">消息面加分</span>` : ''}
                                </div>
                                <div class="bg-secondary bg-opacity-25 p-3 rounded-3xl border border-secondary border-opacity-25">
                                    <strong class="text-light fw-black">回測與反思：</strong> 
                                    <span class="text-secondary">${item.reflection || '無備註'}</span>
                                </div>
                            </div>
                        `;}).join('')}
                    </div>
                </div>
            `;
        }

        function renderForm(container, marketType, id = undefined) {
            const isEdit = typeof id === 'string' && id !== '';
            const isGold = marketType === 'gold';
            let record = isEdit
                ? tradingData[marketType].find(r => r.id === id)
                : {
                    id: Date.now().toString(),
                    date: new Date().toISOString().split('T')[0],
                    item: isGold ? '黃金 XAUUSD' : '',
                    type: '多',
                    rank: '',
                    entryPrice: '',
                    units: isGold ? '0.01' : '1',
                    tp: '',
                    sl: '',
                    exitPrice: '',
                    conditions: [],
                    fundamental: false,
                    news: false,
                    reflection: ''
                };

            container.innerHTML = `
                <div class="page-transition mb-5">
                    <button onclick="navigateTo('details', '${marketType}')" class="btn btn-link text-secondary mb-4 p-0 fw-black">
                        <i class="fas fa-chevron-left me-2"></i> 取消並返回
                    </button>
                    <div class="bg-dark border rounded-4xl overflow-hidden">
                        <div class="bg-secondary bg-opacity-25 px-5 py-4 border-bottom text-center">
                            <h2 class="h4 fw-black text-white mb-0">${isEdit ? '編輯' : '新增'} ${isGold ? '黃金' : '台股'} 紀錄</h2>
                        </div>
                        <form id="trading-form" class="p-5">
                            <div class="row mb-4">
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">進場日期</label>
                                    <input type="date" name="date" value="${record.date}" class="form-control" required>
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">交易標的</label>
                                    ${
                                        !isGold
                                        ? `
                                        <div class="d-flex gap-2 mb-2">
                                            <button type="button" id="tab-auto" class="input-tab active" onclick="switchInputMethod('auto')">自動輸入</button>
                                            <button type="button" id="tab-manual" class="input-tab inactive" onclick="switchInputMethod('manual')">手動輸入</button>
                                        </div>
                                        <div id="auto-lookup-box">
                                            <input type="text" placeholder="例如：2330" class="form-control" oninput="lookupStockId(this.value)">
                                            <p id="auto-lookup-result" class="mt-2 small text-info fw-bold">自動匹配名稱</p>
                                            <input type="hidden" id="item-hidden-input" name="item" value="${record.item}">
                                        </div>
                                        <div id="manual-input-box" class="d-none">
                                            <input type="text" class="form-control" placeholder="手動標的名稱" value="${record.item}" oninput="document.getElementById('item-hidden-input').value = this.value">
                                        </div>`
                                        : `
                                        <input type="text" value="黃金 XAUUSD" class="form-control" readonly>
                                        <input type="hidden" name="item" value="黃金 XAUUSD">
                                        `
                                    }
                                </div>
                                <div class="col-md-4 mb-3">
                                    <label class="form-label">交易方向</label>
                                    <select name="type" id="type-select" class="form-control select-control fw-black" onchange="updateFormUI(this.value, '${marketType}')">
                                        <option value="多" ${record.type === '多' ? 'selected' : ''}>多單 (Long)</option>
                                        <option value="空" ${record.type === '空' ? 'selected' : ''}>空單 (Short)</option>
                                    </select>
                                </div>
                            </div>

                            <section class="mb-4">
                                <h3 class="h6 fw-black text-info mb-3 border-bottom pb-2 text-uppercase">核心評分與等級權重</h3>
                                <div class="row">
                                    <div class="col-md-6 mb-3" id="condition-section"></div>
                                    <div class="col-md-6 mb-3" id="rank-section"></div>
                                </div>
                                <h3 class="h6 fw-black text-info mb-3 border-bottom pb-2 text-uppercase">加分項目</h3>
                                <div class="row">
                                    <div class="col-md-6 mb-2">
                                        <label class="d-flex align-items-center gap-3 p-3 rounded border bg-dark border-secondary cursor-pointer" style="cursor: pointer;">
                                            <input type="checkbox" name="fundamental" ${record.fundamental ? 'checked' : ''} onchange="refreshCalculations()" class="checkbox-input">
                                            <div>
                                                <div class="fw-black text-light">基本面加分</div>
                                                <small class="text-secondary">營收與趨勢良好 +20 Pts</small>
                                            </div>
                                        </label>
                                    </div>
                                    <div class="col-md-6 mb-2">
                                        <label class="d-flex align-items-center gap-3 p-3 rounded border bg-dark border-secondary cursor-pointer" style="cursor: pointer;">
                                            <input type="checkbox" name="news" ${record.news ? 'checked' : ''} onchange="refreshCalculations()" class="checkbox-input">
                                            <div>
                                                <div class="fw-black text-light">消息面加分</div>
                                                <small class="text-secondary">重大新聞或籌碼支撐 +20 Pts</small>
                                            </div>
                                        </label>
                                    </div>
                                </div>
                            </section>

                            <section class="mb-4">
                                <h3 class="h6 fw-black text-info mb-3 border-bottom pb-2 text-uppercase">數據分析</h3>
                                <div class="row align-items-end">
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">單位 <span class="text-secondary small">(${isGold ? '手' : '張'})</span></label>
                                        <input type="text" name="units" value="${record.units}" class="form-control" placeholder="${isGold ? '0.01 手' : '1 張'}">
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">進場價格</label>
                                        <input type="text" id="entry-price" name="entryPrice" value="${record.entryPrice}" class="form-control" oninput="refreshCalculations()" required>
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">停利 TP</label>
                                        <input type="text" id="tp-price" name="tp" value="${record.tp}" class="form-control" oninput="refreshCalculations()">
                                    </div>
                                    <div class="col-md-3 mb-3">
                                        <label class="form-label">停損 SL</label>
                                        <input type="text" id="sl-price" name="sl" value="${record.sl}" class="form-control" oninput="refreshCalculations()">
                                    </div>
                                </div>

                                <div class="mb-3">
                                    <label class="form-label text-info fw-black">出場價格 (有數值即自動判定結單)</label>
                                    <input type="text" id="exit-price" name="exitPrice" value="${record.exitPrice}" class="form-control" placeholder="填入出場價格" oninput="refreshCalculations()">
                                </div>

                                <div class="bg-secondary bg-opacity-10 p-4 rounded-3xl d-flex flex-column flex-md-row justify-content-between align-items-center gap-3 border">
                                    <div class="d-flex gap-4">
                                        <div>
                                            <span class="text-secondary small fw-bold text-uppercase d-block mb-1">預計盈虧比</span>
                                            <span id="rr-preview" class="h5 fw-black text-primary">0.0 R</span>
                                        </div>
                                        <div>
                                            <span class="text-secondary small fw-bold text-uppercase d-block mb-1">判定結果</span>
                                            <span id="result-preview" class="h5 fw-black text-light">-</span>
                                        </div>
                                    </div>
                                    <div class="text-center">
                                        <span class="text-secondary small fw-bold text-uppercase d-block mb-1">綜合得分</span>
                                        <span id="score-preview" class="h3 fw-black text-success">0 Pts</span>
                                    </div>
                                </div>
                            </section>

                            <section class="mb-4">
                                <label class="form-label">複盤與檢討紀錄</label>
                                <textarea name="reflection" rows="10" class="form-control textarea-large">${record.reflection}</textarea>
                            </section>

                            <div class="pt-3">
                                <button type="button" onclick="handleSave('${marketType}', '${isEdit ? record.id : ''}')" class="btn btn-primary w-100 fw-black py-3 text-uppercase">
                                    同步儲存交易紀錄
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            `;
            updateFormUI(record.type, marketType, record.conditions, record.rank);
            refreshCalculations();
        }

        window.updateFormUI = (tradeType, marketType, savedConds = [], savedRank = '') => {
            const condEl = document.getElementById('condition-section');
            const rankEl = document.getElementById('rank-section');

            const conds = (tradeType === '多')
                ? ['Vegas通道往上', 'RSI黃金交叉']
                : ['Vegas通道往下', 'RSI死亡交叉'];
                    
            condEl.innerHTML = `
                <div class="bg-dark border rounded-3xl p-3 h-100 d-flex flex-column justify-content-center">
                    <div class="d-flex flex-column gap-3 text-light fw-black">
                        ${conds.map(c => `
                            <label class="d-flex align-items-center gap-3 cursor-pointer" style="cursor: pointer;">
                                <input type="checkbox" name="conditions" value="${c}" ${savedConds.includes(c) ? 'checked' : ''} onchange="refreshCalculations()" class="checkbox-input">
                                <span>${c}</span>
                            </label>
                        `).join('')}
                    </div>
                </div>
            `;

            const ranks = (tradeType === '多')
                ? [
                    { n: '金單', d: 'VAL插針' },
                    { n: '銀單', d: 'VAL / POC 區間' },
                    { n: '銅單', d: 'POC 處' },
                    { n: '無', d: '未分級' }
                ]
                : [
                    { n: '金單', d: 'VAH插針' },
                    { n: '銀單', d: 'VAL / POC 區間' },
                    { n: '銅單', d: 'POC 處' },
                    { n: '無', d: '未分級' }
                ];

            rankEl.innerHTML = ranks.map(r => {
                const baseClass = r.n === '金單' ? 'rank-gold' : (r.n === '銀單' ? 'rank-silver' : (r.n === '銅單' ? 'rank-bronze' : 'rank-none'));
                const selected = savedRank === r.n ? 'border-white border-3' : '';
                const textClass = (r.n === '金單' || r.n === '銀單' || r.n === '銅單') ? '' : 'text-light';

                return `
                    <label class="d-flex align-items-center gap-3 p-3 rounded border-2 cursor-pointer transition mb-2 ${baseClass} ${textClass} ${selected}" style="cursor: pointer;">
                        <input type="radio" name="rank" value="${r.n}" ${savedRank === r.n ? 'checked' : ''} onchange="refreshCalculations()" class="checkbox-input">
                        <div class="flex-grow-1">
                            <div class="fw-black">${r.n}</div>
                            <small class="opacity-75">${r.d}</small>
                        </div>
                    </label>
                `;
            }).join('');
        };

        window.refreshCalculations = () => {
            const entry = document.getElementById('entry-price')?.value || '';
            const exit = document.getElementById('exit-price')?.value || '';
            const type = document.getElementById('type-select')?.value || '多';
            const tp = document.getElementById('tp-price')?.value || '';
            const sl = document.getElementById('sl-price')?.value || '';

            const res = determineResult(type, entry, exit);
            const resEl = document.getElementById('result-preview');
            if (resEl) {
                resEl.innerText = res;
                resEl.className = `h5 fw-black ${res === '獲利' ? 'text-danger' : (res === '虧損' ? 'text-success' : 'text-light')}`;
            }

            const rrEl = document.getElementById('rr-preview');
            if (rrEl) rrEl.innerText = calculateRR(type, entry, tp, sl) + " R";

            const rank = document.querySelector('input[name="rank"]:checked')?.value;
            const conds = Array.from(document.querySelectorAll('input[name="conditions"]:checked')).map(e => e.value);
            const fundamental = document.querySelector('input[name="fundamental"]')?.checked || false;
            const news = document.querySelector('input[name="news"]')?.checked || false;

            const scoreEl = document.getElementById('score-preview');
            if (scoreEl) scoreEl.innerText = calculateTradeScore({ rank, conditions: conds, fundamental, news }) + " Pts";
        };

        let deleteTarget = { market: null, id: null };
        window.openDeleteModal = (market, id) => {
            deleteTarget = { market, id };
            document.getElementById('delete-modal').style.display = 'flex';
        };
        window.closeDeleteModal = () => document.getElementById('delete-modal').style.display = 'none';
        document.getElementById('confirm-delete-btn').addEventListener('click', () => {
            const { market, id } = deleteTarget;
            tradingData[market] = tradingData[market].filter(r => r.id !== id);
            saveData();
            closeDeleteModal();
            navigateTo('details', market);
        });

        window.handleSave = (market, idStr) => {
            const form = document.getElementById('trading-form');
            const formData = new FormData(form);
            const finalId = (idStr && idStr !== '') ? idStr : Date.now().toString();

            const record = {
                id: finalId,
                date: formData.get('date'),
                item: formData.get('item'),
                type: formData.get('type'),
                rank: formData.get('rank') || '',
                entryPrice: formData.get('entryPrice'),
                units: formData.get('units'),
                tp: formData.get('tp'),
                sl: formData.get('sl'),
                exitPrice: formData.get('exitPrice'),
                conditions: Array.from(document.querySelectorAll('input[name="conditions"]:checked')).map(e => e.value),
                fundamental: document.querySelector('input[name="fundamental"]')?.checked || false,
                news: document.querySelector('input[name="news"]')?.checked || false,
                reflection: formData.get('reflection'),
                timestamp: Date.now()
            };

            const index = tradingData[market].findIndex(r => r.id === finalId);
            if (index > -1) tradingData[market][index] = record;
            else tradingData[market].unshift(record);

            saveData();
            navigateTo('details', market);
        };

        function renderStrategy(container) {
            container.innerHTML = `
                <div class="page-transition">
                    <button onclick="navigateTo('home')" class="btn btn-link text-secondary mb-4 p-0 fw-black">
                        <i class="fas fa-chevron-left me-2"></i> 返回主頁
                    </button>
                    <div class="d-flex align-items-center gap-3 mb-4">
                        <div class="bg-primary text-white p-3 rounded-3xl">
                            <i class="fas fa-scroll h4"></i>
                        </div>
                        <div>
                            <h2 class="h3 fw-black text-white mb-0">核心交易策略框架</h2>
                            <p class="text-secondary fw-bold mb-0">四大支柱：從趨勢到技術執行</p>
                        </div>
                    </div>
                    <div class="row mb-4">
                        <div class="col-md-6 mb-3">
                            <div class="bg-dark p-4 rounded-4xl border">
                                <h3 class="h6 fw-black text-info mb-3">1. 趨勢確認 (Trend)</h3>
                                <p class="text-secondary">依據大時區 Vegas 通道。價格在通道之上且通道向上為多頭；反之為空頭。</p>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="bg-dark p-4 rounded-4xl border">
                                <h3 class="h6 fw-black text-info mb-3">2. 基本面加分 (Fundamental)</h3>
                                <p class="text-secondary">觀察營收與消息面。良好的基本面決定了持倉信心。</p>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="bg-dark p-4 rounded-4xl border">
                                <h3 class="h6 fw-black text-info mb-3">3. 消息面加分 (News)</h3>
                                <p class="text-secondary">關注地緣政治或法人籌碼，消息面常是脫離成本區的觸媒。</p>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <div class="bg-dark p-4 rounded-4xl border">
                                <h3 class="h6 fw-black text-info mb-3">4. 技術執行 (Technical)</h3>
                                <p class="text-secondary">依據 VP 等級判斷入場，結合 RSI 交叉扣板機。嚴格執行 TP/SL。</p>
                            </div>
                        </div>
                    </div>
                    <div class="bg-dark p-4 rounded-4xl border mt-4">
                        <h3 class="h6 fw-black text-info mb-3"><i class="fas fa-brain me-2"></i>總體交易心得與觀察</h3>
                        <textarea id="general-insights-input" class="form-control textarea-large" placeholder="記錄您的市場觀察、心法修煉、或是對近期策略執行率的檢討...">${tradingData.generalInsights || ''}</textarea>
                        <div class="mt-3">
                            <button onclick="saveGeneralInsights()" class="btn btn-primary w-100 fw-black py-3 text-uppercase">
                                <i class="fas fa-save me-2"></i> 儲存總體心得
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        window.saveGeneralInsights = () => {
            const input = document.getElementById('general-insights-input');
            if (input) {
                tradingData.generalInsights = input.value;
                saveData();
                const btn = event.currentTarget;
                const orig = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check me-2"></i> 心得已儲存';
                btn.classList.replace('btn-primary', 'btn-success');
                setTimeout(() => {
                    btn.innerHTML = orig;
                    btn.classList.replace('btn-success', 'btn-primary');
                }, 2000);
            }
        };

        window.switchInputMethod = (method) => {
            const autoBox = document.getElementById('auto-lookup-box');
            const manualBox = document.getElementById('manual-input-box');
            const autoTab = document.getElementById('tab-auto');
            const manualTab = document.getElementById('tab-manual');
            if (method === 'auto') {
                autoBox.classList.remove('d-none');
                manualBox.classList.add('d-none');
                autoTab.classList.add('active');
                autoTab.classList.remove('inactive');
                manualTab.classList.remove('active');
                manualTab.classList.add('inactive');
            } else {
                autoBox.classList.add('d-none');
                manualBox.classList.remove('d-none');
                autoTab.classList.remove('active');
                autoTab.classList.add('inactive');
                manualTab.classList.add('active');
                manualTab.classList.remove('inactive');
            }
        };

        window.lookupStockId = (id) => {
            const display = document.getElementById('auto-lookup-result');
            const hiddenInput = document.getElementById('item-hidden-input');
            if (stockMap[id]) {
                display.innerText = `找到標的：${stockMap[id]}`;
                display.className = "mt-2 small text-info fw-bold";
                hiddenInput.value = `${stockMap[id]} ${id}`;
            } else {
                display.innerText = id.length >= 4 ? "查無代號，請使用手動輸入" : "請輸入 4 碼代號";
                display.className = "mt-2 small text-secondary fw-bold";
                hiddenInput.value = "";
            }
        };

        window.onload = () => navigateTo('home');
    </script>
</body>
</html>
